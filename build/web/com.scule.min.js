if(typeof Scule=="undefined"){var Scule={namespaces:{}}}if(typeof console=="undefined"){var console={log:function(e){}}}(function(){"use strict";Scule.registerNamespace=function(e,t){if(e in Scule){throw"namespace "+e+" is already registered"}Scule[e]=t};Scule.registerComponent=function(e,t,i,s){var r=Scule.require(e);if(!(t in r)){throw"type "+t+" is not registered inside "+e+" namespace"}r[t][i]=s};Scule.require=function(e){if(!(e in Scule)){throw"namespace "+e+" has not been registered, require failed"}return Scule[e]};Scule.registerNamespace("global",{constants:{INDEX_TYPE_BTREE:0,INDEX_TYPE_RTREE:1,INDEX_TYPE_HASH:2,INDEX_TYPE_CLUSTERED:3,ID_FIELD:"_id",REF_FIELD:"_ref"},classes:{},functions:{},variables:{debug:false}});Scule.registerNamespace("datastructures",{constants:Scule.require("global").constants,classes:{},variables:{},$f:Scule.require("global").functions});Scule.registerNamespace("instrumentation",{constants:Scule.require("global").constants,classes:{}});Scule.registerNamespace("parser",{constants:Scule.require("global").constants,classes:{},variables:{lineNo:-1},symbols:{table:{}},arities:{expression:-1,logical:0,binary:1,selective:2,negative:3,range:4,mutate:5,array:6,geospatial:7,variable:8,operand:9,index:10},$f:Scule.require("global").functions});Scule.registerNamespace("builder",{functions:{},classes:{},variables:{line:0},instructions:{}});Scule.registerNamespace("vm",{constants:Scule.require("global").constants,functions:{},classes:{},instructions:{table:{},mapping:{},index:{}},variables:{inst:0},$f:Scule.require("global").functions,$d:Scule.require("datastructures"),$p:Scule.require("parser")});Scule.registerNamespace("db",{constants:Scule.require("global").constants,functions:{},classes:{},plugins:{},engines:{},objects:{core:{collections:{}}},$f:Scule.require("global").functions,$v:Scule.require("vm")})})();(function(){"use strict";Scule.global.classes.sha1=function(){this.hexcase=0;this.b64pad="";this.hex_sha1=function(e){return this.rstr2hex(this.rstr_sha1(this.str2rstr_utf8(e)))};this.hash=function(e){return this.hex_sha1(e)};this.b64_sha1=function(e){return this.rstr2b64(this.rstr_sha1(this.str2rstr_utf8(e)))};this.any_sha1=function(e,t){return this.rstr2any(this.rstr_sha1(this.str2rstr_utf8(e)),t)};this.hex_hmac_sha1=function(e,t){return this.rstr2hex(this.rstr_hmac_sha1(this.str2rstr_utf8(e),this.str2rstr_utf8(t)))};this.b64_hmac_sha1=function(e,t){return this.rstr2b64(this.rstr_hmac_sha1(this.str2rstr_utf8(e),this.str2rstr_utf8(t)))};this.any_hmac_sha1=function(e,t,i){return this.rstr2any(this.rstr_hmac_sha1(this.str2rstr_utf8(e),this.str2rstr_utf8(t)),i)};this.sha1_vm_test=function(){return this.hex_sha1("abc").toLowerCase()=="a9993e364706816aba3e25717850c26c9cd0d89d"};this.rstr_sha1=function(e){return this.binb2rstr(this.binb_sha1(this.rstr2binb(e),e.length*8))};this.rstr_hmac_sha1=function(e,t){var i=this.rstr2binb(e);if(i.length>16){i=this.binb_sha1(i,e.length*8)}var s=new Array(16),r=new Array(16);for(var n=0;n<16;n++){s[n]=i[n]^909522486;r[n]=i[n]^1549556828}var a=this.binb_sha1(s.concat(this.rstr2binb(t)),512+t.length*8);return this.binb2rstr(this.binb_sha1(r.concat(a),512+160))};this.rstr2hex=function(e){this.hexcase=0;var t=this.hexcase?"0123456789ABCDEF":"0123456789abcdef";var i="";var s;for(var r=0;r<e.length;r++){s=e.charCodeAt(r);i+=t.charAt(s>>>4&15)+t.charAt(s&15)}return i};this.rstr2b64=function(e){this.b64pad="";var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";var i="";var s=e.length;for(var r=0;r<s;r+=3){var n=e.charCodeAt(r)<<16|(r+1<s?e.charCodeAt(r+1)<<8:0)|(r+2<s?e.charCodeAt(r+2):0);for(var a=0;a<4;a++){if(r*8+a*6>e.length*8){i+=this.b64pad}else{i+=t.charAt(n>>>6*(3-a)&63)}}}return i};this.rstr2any=function(e,t){var i=t.length;var s=[];var r,n,a,l;var u=new Array(Math.ceil(e.length/2));for(r=0;r<u.length;r++){u[r]=e.charCodeAt(r*2)<<8|e.charCodeAt(r*2+1)}while(u.length>0){l=[];a=0;for(r=0;r<u.length;r++){a=(a<<16)+u[r];n=Math.floor(a/i);a-=n*i;if(l.length>0||n>0){l[l.length]=n}}s[s.length]=a;u=l}var c="";for(r=s.length-1;r>=0;r--){c+=t.charAt(s[r])}var o=Math.ceil(e.length*8/(Math.log(t.length)/Math.log(2)));for(r=c.length;r<o;r++){c=t[0]+c}return c};this.str2rstr_utf8=function(e){var t="";var i=-1;var s,r;while(++i<e.length){s=e.charCodeAt(i);r=i+1<e.length?e.charCodeAt(i+1):0;if(55296<=s&&s<=56319&&56320<=r&&r<=57343){s=65536+((s&1023)<<10)+(r&1023);i++}if(s<=127){t+=String.fromCharCode(s)}else if(s<=2047){t+=String.fromCharCode(192|s>>>6&31,128|s&63)}else if(s<=65535){t+=String.fromCharCode(224|s>>>12&15,128|s>>>6&63,128|s&63)}else if(s<=2097151){t+=String.fromCharCode(240|s>>>18&7,128|s>>>12&63,128|s>>>6&63,128|s&63)}}return t};this.str2rstr_utf16le=function(e){var t="";for(var i=0;i<e.length;i++){t+=String.fromCharCode(e.charCodeAt(i)&255,e.charCodeAt(i)>>>8&255)}return t};this.str2rstr_utf16be=function(e){var t="";for(var i=0;i<e.length;i++){t+=String.fromCharCode(e.charCodeAt(i)>>>8&255,e.charCodeAt(i)&255)}return t};this.rstr2binb=function(e){var t=new Array(e.length>>2);var i=null;for(i=0;i<t.length;i++){t[i]=0}for(i=0;i<e.length*8;i+=8){t[i>>5]|=(e.charCodeAt(i/8)&255)<<24-i%32}return t};this.binb2rstr=function(e){var t="";for(var i=0;i<e.length*32;i+=8){t+=String.fromCharCode(e[i>>5]>>>24-i%32&255)}return t};this.binb_sha1=function(e,t){e[t>>5]|=128<<24-t%32;e[(t+64>>9<<4)+15]=t;var i=new Array(80);var s=1732584193;var r=-271733879;var n=-1732584194;var a=271733878;var l=-1009589776;for(var u=0;u<e.length;u+=16){var c=s;var o=r;var h=n;var f=a;var d=l;for(var g=0;g<80;g++){if(g<16){i[g]=e[u+g]}else{i[g]=this.bit_rol(i[g-3]^i[g-8]^i[g-14]^i[g-16],1)}var p=this.safe_add(this.safe_add(this.bit_rol(s,5),this.sha1_ft(g,r,n,a)),this.safe_add(this.safe_add(l,i[g]),this.sha1_kt(g)));l=a;a=n;n=this.bit_rol(r,30);r=s;s=p}s=this.safe_add(s,c);r=this.safe_add(r,o);n=this.safe_add(n,h);a=this.safe_add(a,f);l=this.safe_add(l,d)}return new Array(s,r,n,a,l)};this.sha1_ft=function(e,t,i,s){if(e<20){return t&i|~t&s}if(e<40){return t^i^s}if(e<60){return t&i|t&s|i&s}return t^i^s};this.sha1_kt=function(e){return e<20?1518500249:e<40?1859775393:e<60?-1894007588:-899497514};this.safe_add=function(e,t){var i=(e&65535)+(t&65535);var s=(e>>16)+(t>>16)+(i>>16);return s<<16|i&65535};this.bit_rol=function(e,t){return e<<t|e>>>32-t}};Scule.getSHA1=function(){return new Scule.global.classes.sha1};Scule.sha1=Scule.getSHA1()})();(function(){"use strict";Scule.global.classes.md5=function(){this.md5cycle=function(e,t){var i=e[0],s=e[1],r=e[2],n=e[3];i=this.ff(i,s,r,n,t[0],7,-680876936);n=this.ff(n,i,s,r,t[1],12,-389564586);r=this.ff(r,n,i,s,t[2],17,606105819);s=this.ff(s,r,n,i,t[3],22,-1044525330);i=this.ff(i,s,r,n,t[4],7,-176418897);n=this.ff(n,i,s,r,t[5],12,1200080426);r=this.ff(r,n,i,s,t[6],17,-1473231341);s=this.ff(s,r,n,i,t[7],22,-45705983);i=this.ff(i,s,r,n,t[8],7,1770035416);n=this.ff(n,i,s,r,t[9],12,-1958414417);r=this.ff(r,n,i,s,t[10],17,-42063);s=this.ff(s,r,n,i,t[11],22,-1990404162);i=this.ff(i,s,r,n,t[12],7,1804603682);n=this.ff(n,i,s,r,t[13],12,-40341101);r=this.ff(r,n,i,s,t[14],17,-1502002290);s=this.ff(s,r,n,i,t[15],22,1236535329);i=this.gg(i,s,r,n,t[1],5,-165796510);n=this.gg(n,i,s,r,t[6],9,-1069501632);r=this.gg(r,n,i,s,t[11],14,643717713);s=this.gg(s,r,n,i,t[0],20,-373897302);i=this.gg(i,s,r,n,t[5],5,-701558691);n=this.gg(n,i,s,r,t[10],9,38016083);r=this.gg(r,n,i,s,t[15],14,-660478335);s=this.gg(s,r,n,i,t[4],20,-405537848);i=this.gg(i,s,r,n,t[9],5,568446438);n=this.gg(n,i,s,r,t[14],9,-1019803690);r=this.gg(r,n,i,s,t[3],14,-187363961);s=this.gg(s,r,n,i,t[8],20,1163531501);i=this.gg(i,s,r,n,t[13],5,-1444681467);n=this.gg(n,i,s,r,t[2],9,-51403784);r=this.gg(r,n,i,s,t[7],14,1735328473);s=this.gg(s,r,n,i,t[12],20,-1926607734);i=this.hh(i,s,r,n,t[5],4,-378558);n=this.hh(n,i,s,r,t[8],11,-2022574463);r=this.hh(r,n,i,s,t[11],16,1839030562);s=this.hh(s,r,n,i,t[14],23,-35309556);i=this.hh(i,s,r,n,t[1],4,-1530992060);n=this.hh(n,i,s,r,t[4],11,1272893353);r=this.hh(r,n,i,s,t[7],16,-155497632);s=this.hh(s,r,n,i,t[10],23,-1094730640);i=this.hh(i,s,r,n,t[13],4,681279174);n=this.hh(n,i,s,r,t[0],11,-358537222);r=this.hh(r,n,i,s,t[3],16,-722521979);s=this.hh(s,r,n,i,t[6],23,76029189);i=this.hh(i,s,r,n,t[9],4,-640364487);n=this.hh(n,i,s,r,t[12],11,-421815835);r=this.hh(r,n,i,s,t[15],16,530742520);s=this.hh(s,r,n,i,t[2],23,-995338651);i=this.ii(i,s,r,n,t[0],6,-198630844);n=this.ii(n,i,s,r,t[7],10,1126891415);r=this.ii(r,n,i,s,t[14],15,-1416354905);s=this.ii(s,r,n,i,t[5],21,-57434055);i=this.ii(i,s,r,n,t[12],6,1700485571);n=this.ii(n,i,s,r,t[3],10,-1894986606);r=this.ii(r,n,i,s,t[10],15,-1051523);s=this.ii(s,r,n,i,t[1],21,-2054922799);i=this.ii(i,s,r,n,t[8],6,1873313359);n=this.ii(n,i,s,r,t[15],10,-30611744);r=this.ii(r,n,i,s,t[6],15,-1560198380);s=this.ii(s,r,n,i,t[13],21,1309151649);i=this.ii(i,s,r,n,t[4],6,-145523070);n=this.ii(n,i,s,r,t[11],10,-1120210379);r=this.ii(r,n,i,s,t[2],15,718787259);s=this.ii(s,r,n,i,t[9],21,-343485551);e[0]=this.add32(i,e[0]);e[1]=this.add32(s,e[1]);e[2]=this.add32(r,e[2]);e[3]=this.add32(n,e[3])};this.cmn=function(e,t,i,s,r,n){t=this.add32(this.add32(t,e),this.add32(s,n));return this.add32(t<<r|t>>>32-r,i)};this.ff=function(e,t,i,s,r,n,a){return this.cmn(t&i|~t&s,e,t,r,n,a)};this.gg=function(e,t,i,s,r,n,a){return this.cmn(t&s|i&~s,e,t,r,n,a)};this.hh=function(e,t,i,s,r,n,a){return this.cmn(t^i^s,e,t,r,n,a)};this.ii=function(e,t,i,s,r,n,a){return this.cmn(i^(t|~s),e,t,r,n,a)};this.md51=function(e){if(/[\x80-\xFF]/.test(e)){e=unescape(encodeURI(e))}var t=e.length,i=[1732584193,-271733879,-1732584194,271733878],s;for(s=64;s<=e.length;s+=64){this.md5cycle(i,this.md5blk(e.substring(s-64,s)))}e=e.substring(s-64);var r=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(s=0;s<e.length;s++){r[s>>2]|=e.charCodeAt(s)<<(s%4<<3)}r[s>>2]|=128<<(s%4<<3);if(s>55){this.md5cycle(i,r);for(s=0;s<16;s++){r[s]=0}}r[14]=t*8;this.md5cycle(i,r);return i};this.md5blk=function(e){var t=[],i;for(i=0;i<64;i+=4){t[i>>2]=e.charCodeAt(i)+(e.charCodeAt(i+1)<<8)+(e.charCodeAt(i+2)<<16)+(e.charCodeAt(i+3)<<24)}return t};this.hex_chr="0123456789abcdef".split("");this.rhex=function(e){var t="",i=0;for(;i<4;i++){t+=this.hex_chr[e>>i*8+4&15]+this.hex_chr[e>>i*8&15]}return t};this.hex=function(e){for(var t=0;t<e.length;t++){e[t]=this.rhex(e[t])}return e.join("")};this.hash=function(e){return this.hex(this.md51(e))};this.add32=function(e,t){return e+t&4294967295}};Scule.getMD5=function(){return new Scule.global.classes.md5};if(Scule.getMD5().hash("hello")!="5d41402abc4b2a76b9719d911017c592"){Scule.global.classes.md5.add32=function(e,t){var i=(e&65535)+(t&65535),s=(e>>16)+(t>>16)+(i>>16);return s<<16|i&65535}}Scule.md5=Scule.getMD5()})();(function(){"use strict";Scule.global.functions.extractTrueValues=function(e){var t={};for(var i in e){if(e.hasOwnProperty(i)){if(i.match(/^\$/)){continue}if(e[i]){t[i]=true}}}return t};Scule.global.functions.pushIfNotNull=function(e,t){if(t){e.push(t)}};Scule.global.functions.pushIfExists=function(e,t,i){if(i in t){e.push(t[i])}};Scule.global.functions.getObjectAttribute=function(e,t,i){if(!(t in e)){return i}return e[t]};Scule.global.functions.getObjectId=function(e,t){if(t===undefined){t=false}return t?e[Scule.global.constants.ID_FIELD].toString():e[Scule.global.constants.ID_FIELD]};Scule.global.functions.cloneObject=function(e){var t={};if(Scule.global.functions.isArray(e)){t=[]}for(var i in e){if(typeof e[i]=="object"){if(e[i]instanceof RegExp){t[i]=new RegExp(e[i].source)}else{t[i]=Scule.global.functions.cloneObject(e[i])}}else{t[i]=e[i]}}return t};Scule.global.functions.traverseObject=function(e,t){var i=0;var s=null;var r=function(e){for(var t in e){if(e.hasOwnProperty(t)){if(e[t]===true){s=t;break}else{i++;r(e[t])}}}};r(e);var n=0;var a=function(e,t){if(n==i){return t}for(var s in e){if(e.hasOwnProperty(s)){if(!t.hasOwnProperty(s)){return null}if(e[s]===true){return t}else{n++;return a(e[s],t[s])}}}};return[s,a(e,t)]};Scule.global.functions.sortObjectKeys=function(e){var t={};var i=[];for(var s in e){if(e.hasOwnProperty(s)){i.push(s)}}i.sort(function(e,t){var i=false;if(e.match(/^\$/)){e=e.substr(1);i=true}var s=false;if(t.match(/^\$/)){t=t.substr(1);s=true}if(i&&!s){return 1}else if(s&&!i){return-1}if(t>e){return-1}else if(t<e){return 1}else{return 0}});i.forEach(function(i){t[i]=e[i]});return t};Scule.global.functions.objectValues=function(e){var t=[];for(var i in e){if(!e.hasOwnProperty(i)){continue}t.push(e[i])}return t};Scule.global.functions.sizeOf=function(e){if(e instanceof Array||typeof e==="string"){return e.length}else{var t=0,i;for(i in e){if(e.hasOwnProperty(i)){t++}}return t}return null};Scule.global.functions.shuffle=function(e){var t,i,s=e.length;if(s){while(--s){i=Math.floor(Math.random()*(s+1));t=e[i];e[i]=e[s];e[s]=t}}};Scule.global.functions.unique=function(e){var t={};for(var i=0;i<e.length;i++){t[e[i]]=true}var s=[];for(var r in t){if(t.hasOwnProperty(r)){s.push(r)}}return s};Scule.global.functions.contains=function(e,t){return t in e};Scule.global.functions.stringify=function(e){var t={};for(var i in e){if(typeof e[i]=="function"){t[i]=e[i].toString()}else{t[i]=e[i]}}return JSON.stringify(t)};Scule.global.functions.isArray=function(e){return Object.prototype.toString.call(e)==="[object Array]"};Scule.global.functions.isInteger=function(e){return parseInt(e,10)==e};Scule.global.functions.isDouble=function(e){return parseFloat(e)==e};Scule.global.functions.isScalar=function(e){return e!==null&&!(e instanceof Object)};Scule.global.functions.randomFromTo=function(e,t){return Math.floor(Math.random()*(t-e+1)+e)};Scule.global.functions.compare=function(e,t){if(e===t){return 0}return e>t?1:-1};Scule.global.functions.compareElementKey=function(e,t){return Scule.global.functions.compare(e.key,t.key)};Scule.global.functions.compareElementValue=function(e,t){return Scule.global.functions.compare(e.value,t.value)};Scule.global.functions.compareArray=function(e,t){if(!Scule.global.functions.isArray(e)&&Scule.global.functions.isArray(t)){return 1}if(Scule.global.functions.isArray(e)&&!Scule.global.functions.isArray(t)){return-1}if(e.length>t.length){return 1}if(t.length>e.length){return-1}var i=true;var s=0;var r=e.length;for(var n=0;n<r;n++){if(Scule.global.functions.isArray(e[n])){s+=Scule.global.functions.compareArray(e[n],t[n])}else{s+=Scule.global.functions.compare(e[n],t[n])}if(s!==0){i=false}}if(s===0&&!i){s=JSON.stringify(e[0]).localeCompare(JSON.stringify(t[0]))}if(s>0){s=1}else if(s<0){s=-1}return s};Scule.global.functions.sort=function(e,t,i){switch(e){case-1:t.sort(function(e,t){return t[i]-e[i]});break;case 0:Scule.global.functions.shuffle(t);break;case 1:t.sort(function(e,t){return e[i]-t[i]});break;case 2:t.sort(function(e,t){if(t[i]>e[i]){return-1}else if(t[i]<e[i]){return 1}else{return 0}});break;case 3:t.sort(function(e,t){if(t[i]<e[i]){return-1}else if(t[i]>e[i]){return 1}else{return 0}});break}};Scule.global.functions.trim=function(e){if(!String.prototype.trim){return e.replace(/(?:(?:^|\n)\s+|\s+(?:$|\n))/g,"").replace(/\s+/g," ")}else{return e.trim()}};Scule.global.functions.getMACAddress=function(){if(!Scule.global.variables.hasOwnProperty("SimulatedMacAddress")){Scule.global.variables.SimulatedMacAddress=(new Date).getTime().toString().substring(9,11)+""+Scule.global.functions.randomFromTo(100,999)}return Scule.global.variables.SimulatedMacAddress};Scule.global.functions.parseAttributes=function(e){if(!Scule.global.functions.isArray(e)){return Scule.global.functions.parseAttributes(e.split(","))}var t=function(e,i,s){var r=Scule.global.functions.trim(i[s]);if(s==i.length-1){e[r]=true}else{var n={};e[r]=n;t(n,i,s+1)}};var i={};e.forEach(function(e){t(i,e.split("."),0)});return i};Scule.global.functions.searchObject=function(e,t){var i=function(e,t,s){if(!t){return}for(var r in e){if(e[r]===true){if(Scule.global.functions.isInteger(r)&&Scule.global.functions.isArray(t)){s.push(t[r])}else{if(r in t){s.push(t[r])}}}else{if(r in t&&!Scule.global.functions.isScalar(t[r])){i(e[r],t[r],s)}}}};var s=[];i(e,t,s);return s};Scule.global.functions.traverse=function(e,t){var i=function(e,t){if(t===undefined){return undefined}if(e.length===1){return t[e.pop()]}else{var s=e.shift();return i(e,t[s])}};return i(e.split("."),t)}})();(function(){"use strict";Scule.datastructures.variables.fnv_hash=function(e,t){var i=2166136261;var s=16777619;var r=e.length;for(var n=0;n<r;n++){i=(i^e.charCodeAt(n))*s}i+=i<<13;i^=i>>7;i+=i<<3;i^=i>>17;i+=i<<5;if(i<0){i=i*-1}return i%t};Scule.datastructures.variables.djb2_hash=function(e,t){var i=5381;var s=e.length;var r=0;for(r=0;r<s;r++){i=(i<<5)+i+e.charCodeAt(r)}if(i<0){i=i*-1}return i%t};Scule.datastructures.variables.joaat_hash=function(e,t){var i=0;var s=e.length;var r=0;for(r=0;r<s;r++){i+=e.charCodeAt(r);i+=i<<10;i^=i>>6}i+=i<<3;i^=i>>11;i+=i<<15;if(i<0){i=i*-1}return i%t};Scule.datastructures.variables.elf_hash=function(e,t){var i=0,s;for(var r=0;r<e.length;r++){i=(i<<4)+e.charCodeAt(r);if(s=i&4026531840){i^=s>>24}i&=~s}return i%t};Scule.datastructures.classes.LinkedList=function(){this.head=null;this.tail=null;this.length=0;this.getHead=function(){return this.head};this.getTail=function(){return this.tail};this.getLength=function(){return this.length};this.isEmpty=function(){return this.length===0};this.clear=function(){this.head=null;this.tail=null;this.length=0};this.get=function(e){if(e<0||e>this.length){return null}if(e===0){return this.head}else{var t=this.head;var i=0;while(t){if(e==i){break}i++;t=t.next}return t}};this.add=function(e){var t=new Scule.datastructures.classes.LinkedListNode(null,e);if(this.head===null){this.head=t}else if(this.tail===null){this.head.next=t;this.tail=t}else{var i=this.tail;i.next=t;this.tail=i.next}this.length++;return t};this.search=function(e,t,i){if(!i){i=Scule.global.functions.compare}var s=this.head;while(s){if(t){if(i(s.element[t],e)===0){break}}else{if(i(s.element,e)===0){break}}s=s.next}return s};this.contains=function(e,t){if(e===null){return false}if(!t){t=Scule.global.functions.compare}var i=this.head;while(i){if(t(i.element,e)===0){break}i=i.next}return i!==null};this.split=function(e){var t;if(e===undefined){e=Math.floor(this.length/2);t=this.middle();if(!t){return null}}else{if(e<1||e>this.length){return null}t=this.get(e-1)}var i=new Scule.datastructures.classes.LinkedList;i.head=t.next;t.next=null;i.tail=this.tail;this.tail=t;i.length=e;this.length=this.length-e;return i};this.middle=function(){if(!this.head){return null}var e=this.head;var t=this.head;while(t.next&&t.next.next){e=e.next;t=t.next.next}return e};this.remove=function(e){if(e<0||e>this.length){return null}var t;if(this.length===1){t=this.head;this.clear()}else{var i=this.get(e-1);if(i.next==this.tail){t=this.tail;this.tail=i}else{t=i.next;i.next=i.next.next}this.length--}return t};this.reverse=function(){var e=null;var t=this.head;var i=null;while(t){i=t.next;t.next=e;e=t;t=i}i=this.head;this.head=this.tail;this.tail=i};this.toArray=function(){var e=[];var t=this.head;while(t){e.push(t.element);t=t.next}return e};this.forEach=function(e){var t=this.head;while(t){e(t);t=t.next}return true};this.sort=function(e,t){if(this.length<2){return this}if(!e){e=Scule.global.functions.compare}var i=function(e){if(!e){return e}var t=e;var i=e;while(i.next&&i.next.next){t=t.next;i=i.next.next}return t};var s=function(i,s){var r={next:null};var n=r;var a;var l;while(i&&s){if(t){a=s.element[t];l=i.element[t]}else{a=s.element;l=i.element}if(e(a,l)>-1){n.next=i;i=i.next}else{n.next=s;s=s.next}n=n.next}n.next=!i?s:i;return r.next};var r=function(e){if(!e||!e.next){return e}var t=i(e);var n=t.next;t.next=null;return s(r(e),r(n))};this.head=r(this.head)}};Scule.datastructures.classes.DoublyLinkedList=function(){this.head=null;this.tail=null;this.length=0;this.getHead=function(){return this.head};this.getTail=function(){return this.tail};this.isEmpty=function(){return this.length===0};this.getLength=function(){return this.length};this.search=function(e,t,i){if(!i){i=Scule.global.functions.compare}var s=this.head;while(s){if(t){if(i(s.element[t],e)===0){break}}else{if(i(s.element,e)===0){break}}s=s.next}return s};this.contains=function(e,t){if(e===null){return false}if(!t){t=Scule.global.functions.compare}var i=this.head;while(i){if(t(i.element,e)===0){break}i=i.next}return i!==null};this.get=function(e){if(e<0||e>this.length){return null}if(e===0){return this.head}else{var t=this.head;var i=0;while(t){if(e==i){break}i++;t=t.next}return t}};this.add=function(e){var t=new Scule.datastructures.classes.DoublyLinkedListNode(null,null,e);if(this.isEmpty()){this.head=t}else if(!this.tail){this.tail=t;this.tail.prev=this.head;this.head.next=t}else{var i=this.tail;i.next=t;t.prev=i;this.tail=t}this.length++;return t};this.remove=function(e){if(e<0||e>this.length){return null}var t;if(this.length===1){t=this.head;this.clear()}else{var i=this.get(e-1);if(i.next==this.tail){t=this.tail;this.tail=i;this.tail.prev=t.prev;this.tail.next=null}else{t=i.next;i.next=i.next.next;if(i.next){i.next.prev=i}}this.length--}if(t){t.detach()}return t};this.trim=function(){if(this.isEmpty()){return null}return this.remove(this.length-1)};this.split=function(e){var t;if(e===undefined){e=Math.floor(this.length/2);t=this.middle();if(!t){return null}}else{if(e<1||e>this.length){return null}t=this.get(e-1)}var i=new Scule.datastructures.classes.DoublyLinkedList;i.head=t.next;t.next=null;t.prev=null;i.tail=this.tail;this.tail=t;i.length=e;this.length=this.length-e;return i};this.middle=function(){if(!this.head){return null}var e=this.head;var t=this.head;while(t.next&&t.next.next){e=e.next;t=t.next.next}return e};this.sort=function(e,t){if(this.length<2){return this}if(!e){e=Scule.global.functions.compare}var i=function(e){if(!e){return e}var t=e;var i=e;while(i.next&&i.next.next){t=t.next;i=i.next.next}return t};var s=function(i,s){var r={next:null};var n=r;var a;var l;while(i&&s){if(t){a=s.element[t];l=i.element[t]}else{a=s.element;l=i.element}if(e(a,l)>-1){n.next=i;n.prev=s;i=i.next}else{n.next=s;n.prev=i;s=s.next}n=n.next}n.next=!i?s:i;return r.next};var r=function(e){if(!e||!e.next){return e}var t=i(e);var n=t.next;t.next=null;n.prev=null;return s(r(e),r(n))};this.head=r(this.head)};this.reverse=function(){var e=this.head;var t=null;while(e){t=e.next;e.next=e.prev;e.prev=t;e=t}t=this.head;this.head=this.tail;this.tail=t};this.prepend=function(e){var t=new Scule.datastructures.classes.DoublyLinkedListNode(null,null,e);if(this.isEmpty()){this.head=t}else{var i=this.head;this.head=t;i.prev=this.head;this.head.next=i;if(!this.tail){this.tail=i}}this.length++;return t};this.clear=function(){this.head=null;this.tail=null;this.length=0};this.toArray=function(){var e=[];var t=this.head;while(t){e.push(t.element);t=t.next}return e};this.forEach=function(e){var t=this.head;while(t){e(t);t=t.next}return true}};Scule.datastructures.classes.CachingLinkedList=function(e,t,i){if(!t){throw"A valid cache key is required to use a CachingLinkedList"}if(!e){e=100}this.cacheKey=t;this.threshold=e;this.cache=new Scule.datastructures.classes.LRUCache(e);if(!i){i=new Scule.datastructures.classes.LinkedList}this.list=i;this.clear=function(){this.cache.clear();this.list.clear()};this.remove=function(e){var t=this.list.remove(e);if(t){this.cache.remove(t.element[this.cacheKey])}return t};this.middle=function(){return this.list.middle()};this.split=function(){this.cache.clear();return this.list.split()};this.add=function(e){var t=this.list.add(e);this.cache.put(t.element[this.cacheKey],t);return t};this.search=function(e){if(this.cache.contains(e)){return this.cache.get(e)}var t=this.list.search(e,this.cacheKey);if(t){this.cache.put(t.element[this.cacheKey],t)}return t};this.getLength=function(){return this.list.getLength()};this.getTail=function(){return this.list.getTail()};this.getHead=function(){return this.list.getHead()};this.isEmpty=function(){return this.list.isEmpty()};this.get=function(e){return this.list.get(e)};this.contains=function(e){return this.list.contains(e)};this.reverse=function(){this.list.reverse()};this.sort=function(e){this.list.sort(e,this.cacheKey)};this.toArray=function(){return this.list.toArray()};this.forEach=function(e){return this.list.forEach(e)}};Scule.datastructures.classes.LinkedListNode=function(e,t){this.next=e;this.element=t;this.getNext=function(){return this.next};this.setNext=function(e){this.next=e};this.getElement=function(){return this.element};this.setElement=function(e){this.element=e}};Scule.datastructures.classes.DoublyLinkedListNode=function(e,t,i){Scule.datastructures.classes.LinkedListNode.call(this,t,i);this.prev=e;this.getPrev=function(){return this.prev};this.setPrev=function(e){this.prev=e};this.detach=function(){this.prev=null;this.next=null}};Scule.datastructures.classes.LRUCache=function(e){this.threshold=e;this.cache=new Scule.datastructures.classes.HashTable;this.queue=new Scule.datastructures.classes.DoublyLinkedList;this.contains=function(e){return this.cache.contains(e)};this.remove=function(e){if(!this.cache.contains(e)){return null}var t=this.cache.get(e);this.cache.remove(e);var i=t.node.prev;var s=t.node.next;if(i){i.next=s}if(s){s.prev=i}t.node.detach();this.queue.length--;return true};this.get=function(e){if(!this.cache.contains(e)){return null}var t=this.cache.get(e);t.requeue(this.queue);return t.value};this.put=function(e,t){var i;if(this.cache.contains(e)){i=this.cache.get(e);i.value=t;i.node.element={key:e,value:t};i.requeue(this.queue)}else{i=new Scule.datastructures.classes.LRUCacheEntry(e,t,this.queue.prepend({key:e,value:t}));this.cache.put(e,i)}if(this.queue.length>this.threshold){var s=this.queue.trim();if(!this.cache.remove(s.getElement().key)){throw"LRU cache is corrupt"}s=null}return true};this.getLength=function(){return this.cache.getLength()};this.clear=function(){this.cache.clear();this.queue.clear()}};Scule.datastructures.classes.LRUCacheEntry=function(e,t,i){this.key=e;this.value=t;this.node=i;this.getKey=function(){return this.key};this.getValue=function(){return this.value};this.getNode=function(){return this.node};this.requeue=function(e){if(!this.node.prev){return}var t=this.node.prev;var i=this.node.next;t.next=i;if(i){i.prev=t}this.node.detach();e.length--;this.node=e.prepend({key:this.key,value:this.value})}};Scule.datastructures.classes.LIFOStack=function(){Scule.datastructures.classes.LinkedList.call(this);this.push=function(e){var t=this.head;this.head=new Scule.datastructures.classes.LinkedListNode(t,e);this.length++};this.pop=function(){if(this.isEmpty()){return null}var e=this.head;this.head=e.next;this.length--;e.next=null;return e.getElement()};this.peek=function(){if(this.isEmpty()){return null}return this.head.getElement()}};Scule.datastructures.classes.FIFOStack=function(){Scule.datastructures.classes.LIFOStack.call(this);this.push=this.add;this.pop=function(){if(this.isEmpty()){return null}var e=this.head;this.head=e.next;this.length--;return e.getElement()}};Scule.datastructures.classes.Queue=function(){Scule.datastructures.classes.FIFOStack.call(this);this.enqueue=this.push;this.dequeue=this.pop};Scule.datastructures.classes.HashMap=function(e){this.size=e;this.buckets=0;this.length=0;this.table=[];this.hash=Scule.datastructures.variables.djb2_hash;this.retable=function(){var e=this.length/this.size;if(this.length>=this.buckets&&e<.7){return}var t=this.toArray();this.clear();this.size=this.size*2;for(var i=0;i<t.length;i++){this.put(t[i][0],t[i][1])}};this.bucket=function(e){if(!this.table[e]){this.buckets++;this.table[e]=new Scule.datastructures.classes.BinarySearchTree}return this.table[e]};this.put=function(e,t){var i=this.hash(e,this.size);var s=this.bucket(i);var r=s.insert(e,t);if(r){this.length++;if(s.getLength()%10===0){s.balance()}}this.retable();return r};this.contains=function(e){var t=this.hash(e,this.size);var i=this.bucket(t);return i.search(e)!==null};this.get=function(e){var t=this.hash(e,this.size);var i=this.bucket(t);var s=i.search(e);if(s===null){return null}return s.getData()};this.search=function(e){return this.get(e)};this.remove=function(e){var t=this.hash(e,this.size);var i=this.bucket(t);if(i.remove(e)){this.length--;this.retable();return true}else{return false}};this.clear=function(){this.table=[];this.length=0;this.buckets=0};this.getLength=function(){return this.length};this.getKeys=function(){var e=[];var t=function(i){if(i===null){return}e.push(i.getKey());t(i.getLeft());t(i.getRight())};this.table.forEach(function(e){if(!e){return}t(e.getRoot())});return e};this.getValues=function(){var e=[];var t=function(i){if(i===null){return}e.push(i.getData());t(i.getLeft());t(i.getRight())};this.table.forEach(function(e){if(!e){return}t(e.getRoot())});return e};this.toArray=function(){var e=[];this.table.forEach(function(t){if(!t){return}e=e.concat(t.toArray())});return e}};Scule.datastructures.classes.HashTable=function(){this.table={};this.length=0;this.put=function(e,t){if(!this.contains(e)){this.length++}this.table[e]=t};this.get=function(e){if(this.contains(e)){return this.table[e]}return null};this.search=function(e){return this.get(e)};this.remove=function(e){if(this.contains(e)){delete this.table[e];this.length--;return true}return false};this.contains=function(e){return e in this.table};this.clear=function(){this.table={};this.length=0};this.getLength=function(){return this.length};this.getKeys=function(){var e=[];for(var t in this.table){if(this.table.hasOwnProperty(t)){e.push(t)}}return e};this.getValues=function(){var e=[];for(var t in this.table){if(this.table.hasOwnProperty(t)){e.push(this.table[t])}}return e};this.toArray=function(){var e=[];for(var t in this.table){if(this.table.hasOwnProperty(t)){e[t]=this.table[t]}}return e}};Scule.datastructures.classes.BPlusTreeNode=function(){this.leaf=false;this.order=100;this.threshold=40;this.data=[];this.getOrder=function(){return this.order};this.setOrder=function(e){this.order=e};this.getMergeThreshold=function(){return this.threshold};this.setMergeThreshold=function(e){this.threshold=e};this.isLeaf=function(){return this.leaf}};Scule.datastructures.classes.BPlusTreeLeafNode=function(e,t){Scule.datastructures.classes.BPlusTreeNode.call(this);this.leaf=true;this.left=e;this.right=t;this.getRight=function(){return this.right};this.setRight=function(e){this.right=e};this.getLeft=function(){return this.left};this.setLeft=function(e){this.left=e};this.lookup=new Scule.datastructures.classes.LRUCache(Math.floor(this.threshold/2));this.search=function(e){var t=this.lookup.get(e);if(!t){t=this.sequentialSearch(e);if(t){this.lookup.put(t.key,t)}else{return null}}return t.value};this.sequentialSearch=function(e){var t=this.indexSearch(e);var i=this.data[t];if(t<this.data.length&&i.key==e){return i}return null};this.indexSearch=function(e){var t=this.data;if(t.length===0){return 0}var i=0;var s=this.data.length-1;var r=i+Math.floor((s-i)/2);var n=false;do{r=i+Math.floor((s-i)/2);if(t[r].key<e){i=r+1}else if(t[r].key>e){s=r}else{n=true}}while(i<s&&!n);if(n){return r}else{return s}};this.identifySiblings=function(e){var t={index:null,left:null,key:null,right:null};var i=this.getRight();var s=this.getLeft();var r=0;for(;r<e.data.length;r=r+2){var n=e.data[r];if(n==i){t.right=i;t.index=r-2;t.right_key=e.data[r-1];t.right_key_index=r-1}if(n==s){t.left=s;t.index=r+2;t.left_key=e.data[r+1];t.left_key_index=r+1}}if(t.index===null){t.index=r>=2?r-2:0}return t};this.getKeys=function(){var e=[];this.data.forEach(function(t){e.push(t.key)});return e};this.insert=function(e,t){var i=this.indexSearch(e);if(i==this.data.length){this.data.push({key:e,value:t})}else{var s=this.data[i];if(s.key==e){s.value=t}else if(s.key<e){this.data.splice(i+1,0,{key:e,value:t})}else{this.data.splice(i,0,{key:e,value:t})}}this.lookup.put(e,{key:e,value:t});return this.split()};this.remove=function(e,t){var i=this.indexSearch(e);var s=this.data[i];if(i<this.data.length&&s.key==e){this.data.splice(i,1);this.lookup.remove(e);if(!t){return null}return this.redistribute(e,t)
}else{return null}};this.redistribute=function(e,t){if(this.data.length>this.threshold){return{operation:2,oldkey:e,key:this.data[0].key}}var i=this.identifySiblings(t);var s=this.threshold-this.data.length;var r,n;var a=false;if(i.left){r=i.left;n=i.left_key;a=true;if(r.data.length-s>=this.threshold){this.data=r.data.splice(s*-1,s).concat(this.data);this.lookup.clear();return{key:this.data[0].key,oldkey:i.left_key,index:i.left_key_index,operation:0}}}if(i.right){r=i.right;n=i.right_key;a=false;if(r.data.length-s>=this.threshold){this.data=this.data.concat(r.data.splice(0,s));this.lookup.clear();return{key:r.data[0].key,oldkey:i.right_key,index:i.right_key_index,operation:0}}}return this.merge(r,i.index,n,a)};this.merge=function(e,t,i,s){if(this.data.length>this.threshold){return null}if(!e){throw"Unable to merge - no siblings"}if(s){e.data=e.data.concat(this.data.splice(0,this.data.length));e.setRight(this.getRight());if(e.getRight()){e.getRight().setLeft(e)}e.lookup.clear();this.setLeft(null);this.setRight(null);return{left:true,index:t,node:e,key:e.data[0].key,oldkey:i,operation:1}}else{var r=this.data.splice(0,this.data.length);e.data=r.concat(e.data.splice(0,e.data.length));e.setLeft(this.getLeft());if(e.getLeft()){e.getLeft().setRight(e)}e.lookup.clear();this.setLeft(null);this.setRight(null);return{left:false,index:t,key:e.data[0].key,node:e,oldkey:i,operation:1}}};this.range=function(e,t,i,s){if(s===undefined){s=false}if(i===undefined){i=false}if(e===undefined){e=null}if(t===undefined){t=null}var r=this;var n=null;if(i&&s){n=function(e,t,i,s,r){if(e===null){if(i<=t){s=s.concat(r)}}else if(t===null){if(i>=e){s=s.concat(r)}}else{if(i>=e&&i<=t){s=s.concat(r)}}return s}}else if(i){n=function(e,t,i,s,r){if(e===null){if(i<t){s=s.concat(r)}}else if(t===null){if(i>=e){s=s.concat(r)}}else{if(i>=e&&i<t){s=s.concat(r)}}return s}}else{n=function(e,t,i,s,r){if(e===null){if(i<=t){s=s.concat(r)}}else if(t===null){if(i>e){s=s.concat(r)}}else{if(i>e&&i<=t){s=s.concat(r)}}return s}}var a=[];e:while(r){var l=r.data;var u=r.indexSearch(e);var c=t===null||t===undefined?l.length-1:r.indexSearch(t);if(c>=l.length){c=l.length-1}if(u<=l.length){for(var o=u;o<=c;o++){if(t!==null&&l[o].key>t){break e}a=n(e,t,l[o].key,a,l[o].value)}}r=r.getRight()}return a};this.split=function(){if(this.data.length<=this.order){return null}var e=Math.floor(this.data.length/2);var t=new Scule.datastructures.classes.BPlusTreeLeafNode(this.getLeft());t.setOrder(this.getOrder());t.setMergeThreshold(this.getMergeThreshold());t.data=this.data.splice(0,e);var i=new Scule.datastructures.classes.BPlusTreeLeafNode(null,this.getRight());i.setOrder(this.getOrder());i.setMergeThreshold(this.getMergeThreshold());i.data=this.data.splice(0,e+1);t.setRight(i);if(this.getLeft()){this.getLeft().setRight(t)}i.setLeft(t);if(this.getRight()){this.getRight().setLeft(i)}return{left:t,key:i.data[0].key,right:i}};this.toString=function(){return JSON.stringify(this.toArray(),null,"	")};this.toArray=function(){var e={type:"leaf"};for(var t=0;t<this.data.length;t++){e[t+":"+this.data[t].key]=this.data[t]}return e}};Scule.datastructures.classes.BPlusTreeInteriorNode=function(){Scule.datastructures.classes.BPlusTreeNode.call(this);this.nodeSearch=function(e){var t=this.data.length;for(var i=1;i<t;i=i+2){var s=this.data[i];if(s==e){return i+1}else if(s>=e){return i-1}}return t-1};this.indexSearch=function(e){var t=this.data.length;for(var i=1;i<t;i=i+2){var s=this.data[i];if(s==e){return i}else if(s>=e){return i}}return t-2};this.childSearch=function(e){if(this.data.length===0){return null}return this.data[this.nodeSearch(e)]};this.search=function(e){return this.childSearch(e).search(e)};this.range=function(e,t,i,s){return this.childSearch(e).range(e,t,i,s)};this.insert=function(e,t){var i=this.indexSearch(e);if(this.data[i]>e){i--}else{i++}var s=this.data[i];var r=s.insert(e,t);if(r){this.data.splice(i,1,r.left,r.key,r.right)}return this.split()};this.split=function(){var e=Math.floor((this.data.length-1)/2);if(e<this.order){return null}var t=Math.floor((this.data.length-1)/2);var i=new Scule.datastructures.classes.BPlusTreeInteriorNode(this.left,null);i.setOrder(this.order);i.setMergeThreshold(this.threshold);i.data=this.data.splice(0,t);var s=new Scule.datastructures.classes.BPlusTreeInteriorNode(null,this.right);s.setOrder(this.order);s.setMergeThreshold(this.threshold);s.data=this.data.splice(1,t);return{left:i,key:this.data[0],right:s}};this.remove=function(e,t){var i=this.indexSearch(e);var s=i;if(this.data[i]>e){s=i-1}else{s=i+1}var r=this.data[s];var n=r.remove(e,this);if(!n){return null}switch(n.operation){case 0:break;case 1:if(this.data.length==3){return n.node}var a=n.index;if(n.left){a=n.index-2}this.data.splice(a,3,n.node);break;case 2:var l=false;for(var u=1;u<this.data.length;u=u+2){if(this.data[u]==n.oldkey){this.data[u]=n.key;l=true}}if(!l){if(!t){return null}return n}break}this.reassignKeys();return this.merge(t,n.key,e)};this.reassignKeys=function(){for(var e=2;e<this.data.length;e=e+2){if(this.data[e].isLeaf()){this.data[e-1]=this.data[e].data[0].key}}};this.merge=function(e,t,i){if(!e){return null}var s=Math.floor((this.data.length-1)/2);if(s>=this.threshold-1){return{key:t,oldkey:i,operation:2}}var r,n,a;var l=false;var u=0;for(;u<e.data.length;u=u+2){if(e.data[u]==this){if(u===0||u<e.data.length-1){a=e.data[u+2];r=u+1}else{l=true;a=e.data[u-2];r=u-1}break}}n=e.data[r];var c=new Scule.datastructures.classes.BPlusTreeInteriorNode;c.setOrder(this.getOrder());c.setMergeThreshold(this.getMergeThreshold());if(l){c.data=a.data.splice(0,a.data.length);c.data=c.data.concat(n);c.data=c.data.concat(this.data.splice(0,this.data.length))}else{c.data=this.data.splice(0,this.data.length);c.data=c.data.concat(n);c.data=c.data.concat(a.data.splice(0,a.data.length))}return{left:l,node:c,index:u,oldkey:n,operation:1}};this.toString=function(){return JSON.stringify(this.toArray(),null,"	")};this.toArray=function(){var e={type:"interior"};var t=0;var i=1;while(i<this.data.length){e[i+":"+this.data[i]]={left:this.data[t].toArray(),right:this.data[t+2].toArray()};t=t+2;i=i+2}return e}};Scule.datastructures.classes.BPlusTree=function(e,t){if(!e){e=100}if(!t){t=Math.ceil(e/2)}this.order=e;this.threshold=t;this.root=new Scule.datastructures.classes.BPlusTreeLeafNode;this.root.setOrder(this.order);this.root.setMergeThreshold(this.threshold);this.insert=function(e,t){var i=this.root.insert(e,t);if(i){this.root=new Scule.datastructures.classes.BPlusTreeInteriorNode;this.root.setOrder(this.order);this.root.setMergeThreshold(this.threshold);this.root.data.push(i.left);this.root.data.push(i.key);this.root.data.push(i.right)}return true};this.search=function(e){return this.root.search(e)};this.range=function(e,t,i,s){return this.root.range(e,t,i,s)};this.remove=function(e){var t=this.root.remove(e);if(t){this.root=t}return true};this.clear=function(){this.root=new Scule.datastructures.classes.BPlusTreeLeafNode;this.root.setOrder(this.order);this.root.setMergeThreshold(this.threshold)};this.toString=function(){return this.root.toString()};this.toArray=function(){return this.root.toArray()}};Scule.datastructures.classes.BinarySearchTreeNode=function(e,t){this.parent=null;this.left=null;this.right=null;this.key=e;this.data=t;this.setParent=function(e){this.parent=e};this.getParent=function(){return this.parent};this.setLeft=function(e){if(!e){return}this.left=e;this.left.setParent(this)};this.getLeft=function(){return this.left};this.setRight=function(e){if(!e){return}this.right=e;this.right.setParent(this)};this.getRight=function(){return this.right};this.getKey=function(){return this.key};this.setData=function(e){this.data=e};this.getData=function(){return this.data};this.clear=function(){this.data=null};this.remove=function(e){if(!e){return false}if(e==this.right){this.setRight(e.getRight());this.getRight().setLeft(e.getLeft());e.parent=null;e.left=null;e.right=null;return true}else if(e==this.left){this.setLeft(e.getRight());this.getLeft().setLeft(e.getLeft());e.parent=null;e.left=null;e.right=null;return true}return false}};Scule.datastructures.classes.AtomicCounter=function(e){if(e===undefined){e=0}if(!Scule.global.functions.isInteger(e)){throw"Unable to initialize counter with non-integer value"}this.count=e;this.increment=function(e){if(e===undefined){e=1}if(!Scule.global.functions.isInteger(e)){throw"Unable to increment counter with non-integer value"}this.count+=e;return this.count};this.decrement=function(e){if(e===undefined){e=1}if(!Scule.global.functions.isInteger(e)){throw"Unable to decrement counter with non-integer value"}this.count-=e;return this.count};this.getCount=function(){return this.count}};Scule.datastructures.classes.BinarySearchTree=function(){this.root=null;this.length=0;this.insert=function(e,t){var i=this;var s=new Scule.datastructures.classes.BinarySearchTreeNode(e,t);if(this.root===null){this.length++;this.root=s;return true}var r=function(e,t){if(e.getKey()==t.getKey()){t.setData(e.getData());return false}if(e.getKey()<=t.getKey()){if(!t.getLeft()){i.length++;t.setLeft(e)}else{r(e,t.getLeft())}}else{if(!t.getRight()){i.length++;t.setRight(e)}else{r(e,t.getRight())}}return true};return r(s,this.root)};this.search=function(e){var t=function(e,i){if(!i){return null}if(i.getKey()==e){return i}else if(i.getKey()>e){return t(e,i.getLeft())}else{return t(e,i.getRight())}};return t(e,this.root)};this.remove=function(e){var t=this.search(e);if(!t){return false}if(!t.getParent()){if(t.getRight()){this.root=t.getRight();this.root.setLeft(t.getLeft())}else if(t.getLeft()){this.root=t.getRight();this.root.setLeft(t.getLeft())}else{this.root=null}this.length--;return true}var i=t.getParent().remove(t);if(i){this.length--}return i};this.balance=function(){var e=this;var t=this.toArray();var i=function(t){var s=t;var r=t.splice(Math.ceil(t.length/2),t.length);var n=s.pop();e.insert(n[0],n[1]);if(s.length>0){i(s)}if(r.length>0){i(r)}};this.length=0;this.root=null;i(t)};this.getLength=function(){return this.length};this.toArray=function(){var e=function(t){if(!t){return[]}return e(t.getLeft()).concat([[t.getKey(),t.getData()]]).concat(e(t.getRight()))};return e(this.root)};this.getRoot=function(){return this.root}};Scule.datastructures.classes.BitSet=function(e){if(e===undefined||!Scule.global.functions.isInteger(e)||e<=0){throw"Unable to initialize bitset with non-integer capacity"}this.capacity=e;this.words=null;this.zeroFill=function(){this.words=[];var e=Math.ceil(this.capacity/32);for(var t=0;t<=e;t++){this.words[t]=0}};this.indexToAddress=function(e){if(e<0||e>=this.capacity){throw"Index out of bounds"}if(e<32){return{addr:0,offs:e}}var t=Math.floor(e/32);var i=e%32;return{addr:t,offs:i}};this.get=function(e){var t=this.indexToAddress(e);return(this.words[t.addr]&1<<t.offs)!=0};this.set=function(e){var t=this.indexToAddress(e);this.words[t.addr]|=1<<t.offs};this.clear=function(e){var t=this.indexToAddress(e);this.words[t.addr]&=~(1<<t.offs)};this.getLength=function(){return this.capacity};this.toString=function(){var e="";for(var t=0;t<this.capacity;t++){e+=this.get(t)?1:0}return e};this.zeroFill()};Scule.datastructures.classes.BloomFilter=function(e,t){if(e===undefined||!Scule.global.functions.isInteger(e)||e<=0){throw"Unable to initialize bloom filter with non-integer m"}if(t===undefined||!Scule.global.functions.isInteger(t)||t<=0){t=Math.floor(e/Math.ceil(e/3))}Scule.datastructures.classes.BitSet.call(this,e);this.k=t;this.f=[];for(var i=0;i<this.k;i++){this.f.push([Scule.global.functions.randomFromTo(0,999999),Scule.global.functions.randomFromTo(0,999999)])}this.hash=function(e,t,i){return Scule.datastructures.variables.fnv_hash(this.f[e][0]+t+this.f[e][1],i)};this.add=function(e){for(var t=0;t<this.k;t++){this.set(this.hash(t,e,this.capacity))}};this.query=function(e){for(var t=0;t<this.k;t++){if(!this.get(this.hash(t,e,this.capacity))){return false}}return true}};Scule.datastructures.classes.AtomicCounter=function(e){if(e===undefined){e=0}if(!Scule.global.functions.isInteger(e)){throw"Unable to initialize counter with non-integer value"}this.count=e;this.increment=function(e){if(e===undefined){e=1}if(!Scule.global.functions.isInteger(e)){throw"Unable to increment counter with non-integer value"}this.count+=e;return this.count};this.decrement=function(e){if(e===undefined){e=1}if(!Scule.global.functions.isInteger(e)){throw"Unable to decrement counter with non-integer value"}this.count-=e;return this.count};this.getCount=function(){return this.count}};Scule.getLinkedList=function(){return new Scule.datastructures.classes.LinkedList};Scule.getCachingLinkedList=function(e,t){return new Scule.datastructures.classes.CachingLinkedList(e,t)};Scule.getDoublyLinkedList=function(){return new Scule.datastructures.classes.DoublyLinkedList};Scule.getHashTable=function(){return new Scule.datastructures.classes.HashTable};Scule.getHashMap=function(e){return new Scule.datastructures.classes.HashMap(e)};Scule.getLIFOStack=function(){return new Scule.datastructures.classes.LIFOStack};Scule.getFIFOStack=function(){return new Scule.datastructures.classes.FIFOStack};Scule.getQueue=function(){return new Scule.datastructures.classes.Queue};Scule.getLRUCache=function(e){return new Scule.datastructures.classes.LRUCache(e)};Scule.getBPlusTree=function(e,t){return new Scule.datastructures.classes.BPlusTree(e,t)};Scule.getBPlusTreeNode=function(){return new Scule.datastructures.classes.BPlusTreeNode};Scule.getBPlusTreeLeafNode=function(e,t){return new Scule.datastructures.classes.BPlusTreeLeafNode(e,t)};Scule.getBPlusTreeInteriorNode=function(){return new Scule.datastructures.classes.BPlusTreeInteriorNode};Scule.getBinarySearchTreeNode=function(e,t){return new Scule.datastructures.classes.BinarySearchTreeNode(e,t)};Scule.getBinarySearchTree=function(){return new Scule.datastructures.classes.BinarySearchTree};Scule.getAtomicCounter=function(e){return new Scule.datastructures.classes.AtomicCounter(e)};Scule.getBitSet=function(e){return new Scule.datastructures.classes.BitSet(e)};Scule.getBloomFilter=function(e){return new Scule.datastructures.classes.BloomFilter(e)}})();(function(){"use strict";Scule.instrumentation.classes.Timer=function(){this.intervalCounter=0;this.intervalArray=[];this.intervals=Scule.getLIFOStack();this.resetTimer=function(){this.intervalCounter=0;this.intervalArray=[];this.intervals.clear()};this.startInterval=function(e){this.intervalCounter++;if(e===undefined){e=this.intervalCounter}this.intervals.push(new Scule.instrumentation.classes.TimerInterval(e));this.intervalArray.push(this.intervals.peek())};this.stopInterval=function(){if(this.intervals.isEmpty()){return false}this.intervals.peek().stop();return this.intervals.pop()};this.stopAllIntervals=function(){while(!this.intervals.isEmpty()){this.intervals.pop().stop()}};this.logToConsole=function(){this.intervalArray.forEach(function(e){e.logToConsole()})}};Scule.instrumentation.classes.TimerInterval=function(e){this.startTimestamp=(new Date).getTime();this.endTimestamp=null;this.tag=e;this.stopped=function(){return this.endTimestamp!==null};this.stop=function(){this.endTimestamp=(new Date).getTime()};this.getDifference=function(){if(this.endTimestamp===null){return false}return this.endTimestamp-this.startTimestamp};this.logToConsole=function(){var e=this.getDifference();if(e===false){console.log("interval "+this.tag+" is still in progress")}console.log("interval "+this.tag+" lasted "+e+"ms")}};Scule.getTimer=function(){return new Scule.instrumentation.classes.Timer}})();(function(){"use strict";Scule.parser.symbols.table={$and:Scule.parser.arities.selective,$or:Scule.parser.arities.selective,$nor:Scule.parser.arities.negative,$not:Scule.parser.arities.negative,$lt:Scule.parser.arities.range,$lte:Scule.parser.arities.range,$gt:Scule.parser.arities.range,$gte:Scule.parser.arities.range,$all:Scule.parser.arities.array,$in:Scule.parser.arities.array,$nin:Scule.parser.arities.array,$eq:Scule.parser.arities.binary,$ne:Scule.parser.arities.binary,$size:Scule.parser.arities.binary,$exists:Scule.parser.arities.binary,$within:Scule.parser.arities.geospatial,$near:Scule.parser.arities.geospatial,$set:Scule.parser.arities.mutate,$inc:Scule.parser.arities.mutate,$unset:Scule.parser.arities.mutate,$pull:Scule.parser.arities.mutate,$pullAll:Scule.parser.arities.mutate,$pop:Scule.parser.arities.mutate,$push:Scule.parser.arities.mutate,$pushAll:Scule.parser.arities.mutate,$rename:Scule.parser.arities.mutate};Scule.parser.classes.QueryTree=function(){this.root=null;this.setRoot=function(e){this.root=e};this.getRoot=function(){return this.root};this.normalize=function(){this.root.normalize()};this.setOrs=function(e){if(e.length===0){return false}var t=new Scule.parser.classes.QueryOperand("$and",Scule.parser.arities.selective);e.forEach(function(e){t.addChild(e)});this.root.addChild(t)};this.accept=function(e){e.visit(this)}};Scule.parser.classes.QuerySymbol=function(e,t){this.children=[];this.symbol=e;this.type=t;this.setSymbol=function(e){this.symbol=e};this.getSymbol=function(){return this.symbol};this.setType=function(e){this.type=e};this.getType=function(){return this.type};this.addChild=function(e){this.children.push(e)};this.getChildren=function(){return this.children};this.countOperands=function(){var e=0;var t=function(i){i.children.forEach(function(i){if(i.getType()==Scule.parser.arities.operand){e++}else{t(i)}})};t(this);return e};this.getChild=function(e){if(e>this.children.length||!this.children[e]){return null}return this.children[e]};this.getFirstChild=function(){return this.getChild(0)};this.hasChildren=function(){return this.children.length>0};this.normalize=function(){var e=null;var t=0;for(;t<this.children.length;t++){if(this.children.length===0){break}e=this.children[t];if(e.getType()==Scule.parser.arities.selective){if(!e.hasChildren()){this.children.splice(t,1);t--}else{e.normalize();if(!e.hasChildren()){this.children.splice(t,1);t--}}}}}};Scule.parser.classes.QueryExpression=function(){Scule.parser.classes.QuerySymbol.call(this);this.type=Scule.parser.arities.expression};Scule.parser.classes.QueryOperator=function(e,t){Scule.parser.classes.QuerySymbol.call(this,e,t)};Scule.parser.classes.QueryOperand=function(e,t){Scule.parser.classes.QuerySymbol.call(this,e,t)};Scule.parser.classes.QueryVariable=function(e){Scule.parser.classes.QuerySymbol.call(this,e);this.type=Scule.parser.arities.variable};Scule.parser.classes.QueryIndex=function(e){Scule.parser.classes.QuerySymbol.call(this,e);this.type=Scule.parser.arities.index;this.index=null;this.range=false;this.args=[]};Scule.parser.classes.QueryParser=function(){this.parseQuery=function(e){var t=new Scule.parser.classes.QueryTree;var i=Scule.getLIFOStack();var s=Scule.getHashTable();var r=[];var n=false;var a=new Scule.parser.classes.QueryExpression;t.setRoot(a);i.push(a);var l=function(e,a){var u;var c=i.peek().getType();if(Scule.global.functions.isScalar(e)||e instanceof RegExp){if(c==Scule.parser.arities.variable||c==Scule.parser.arities.selective){u=new Scule.parser.classes.QueryOperator("$eq",Scule.parser.arities.binary);i.peek().addChild(u);u.addChild(new Scule.parser.classes.QueryOperand(e,Scule.parser.arities.operand))}else{i.peek().addChild(new Scule.parser.classes.QueryOperand(e,Scule.parser.arities.operand))}return}if(Scule.global.functions.isArray(e)){if(i.peek().getType()==Scule.parser.arities.selective){var o=e.length;if(e.length<2){throw"operator "+i.peek().getSymbol()+" requires two or more sub-expression"}var h=0;var f=i.peek().getSymbol();for(;h<o;h++){if(f in e[h]){throw"operator "+i.peek().getSymbol()+" cannot be nested"}l(e[h],a++)}}else{var d=Scule.getHashTable();e.forEach(function(e){d.put(e,true)});i.peek().addChild(new Scule.parser.classes.QueryOperand(d,Scule.parser.arities.operand))}return}else{var g=i.peek().getSymbol();if(g=="$near"||g=="$within"){if(!("lat"in e)||!("lon"in e)||!("distance"in e)){throw g+" operator requires lat, lon, and distance attributes - e.g. {lat:30, lon:-30, distance:10}"}i.peek().addChild(new Scule.parser.classes.QueryOperand(e,Scule.parser.arities.operand));return}}if(!i.isEmpty()&&i.peek().getSymbol()!=="$and"){u=new Scule.parser.classes.QueryOperand("$and",Scule.parser.arities.selective);i.peek().addChild(u);i.push(u)}for(var p in e){if(p in Scule.parser.symbols.table){u=new Scule.parser.classes.QueryOperator(p,Scule.parser.symbols.table[p]);if(p=="$or"){n=true;r.push(u)}else{i.peek().addChild(u)}i.push(u);l(e[p],a++);if(!i.isEmpty()&&i.pop().getSymbol()=="$or"){n=false}}else{u=new Scule.parser.classes.QueryVariable(p);if(!n){if(s.contains(p)){var v=s.get(p);if(v.getType()!==Scule.parser.arities.selective){if(v.getFirstChild().getType()!==Scule.parser.arities.selective){var S=new Scule.parser.classes.QueryOperand("$and",Scule.parser.arities.selective);S.addChild(v.getFirstChild());v.children[0]=S;s.put(p,S)}else{s.put(p,v.getFirstChild())}}i.push(s.get(p))}else{s.put(p,u);t.getRoot().addChild(u);i.push(u)}}else{i.peek().addChild(u);i.push(u)}l(e[p],a++);i.pop()}}i.pop()};l(e,0);t.setOrs(r);t.normalize();return t}};Scule.getQueryTree=function(){return new Scule.parser.classes.QueryTree};Scule.getQuerySymbol=function(e,t){return new Scule.parser.classes.QuerySymbol(e,t)};Scule.getQueryParser=function(){return new Scule.parser.classes.QueryParser}})();(function(){"use strict";Scule.builder.instructions.table={halt:0,and:1,or:2,nor:3,not:4,lt:5,lte:6,gt:7,gte:8,all:9,"in":10,nin:11,eq:12,ne:13,size:14,exists:15,within:16,near:17,set:18,unset:19,inc:20,opull:21,opullall:22,opop:23,opush:24,opushall:25,"break":26,find:27,scan:28,range:29,push:30,pop:31,shift:32,store:33,merge:34,intersect:35,start:36,jump:37,"goto":38,read:39,transpose:40,limit:41,sort:42,rread:43,rindex:44};Scule.builder.instructions.lookup={0:"halt",1:"and",2:"or",3:"nor",4:"not",5:"lt",6:"lte",7:"gt",8:"gte",9:"all",10:"in",11:"nin",12:"eq",13:"ne",14:"size",15:"exists",16:"within",17:"near",18:"set",19:"unset",20:"inc",21:"opull",22:"opullall",23:"opop",24:"opush",25:"opushall",26:"break",27:"find",28:"scan",29:"range",30:"push",31:"pop",32:"shift",33:"store",34:"merge",35:"intersect",36:"start",37:"jump",38:"goto",39:"read",40:"transpose",41:"limit",42:"sort",43:"rread",44:"rindex"};Scule.builder.instructions.mapping={$eq:"eq",$ne:"ne",$gt:"gt",$gte:"gte",$lt:"lt",$lte:"lte",$in:"in",$nin:"nin",$all:"all",$size:"size",$exists:"exists",$near:"near",$within:"within",$and:"and",$or:"or",$limit:"limit",$sort:"sort",$set:"set",$unset:"unset",$inc:"inc",$push:"opush",$pushAll:"opushall",$pull:"opull",$pullAll:"opullall",$pop:"opop"};Scule.builder.instructions.index={find:true,range:true,scan:true};Scule.builder.classes.QueryTreeIndexSelectionVisitor=function(e){this.collection=e;this.setCollection=function(e){this.collection=e};this.getCollection=function(){return this.collection};this.visit=function(e){var t=Scule.global.functions.cloneObject(e.getRoot());try{this.visitNode(t)}catch(i){return}e.setRoot(t)};this.visitNode=function(e){var t=this;var i=Scule.getHashTable();var s=Scule.getHashTable();this.populateAttributes(e,i,s);i=i.getKeys().sort();s=s.getKeys().sort();if(i.length===0&&s.length===0){return}var r=null;var n=this.collection.indices;for(var a=0;a<n.length;a++){var l=n[a];r=l.applies(s,false);if(r){t.selectExactIndexes(e,r)}r=l.applies(i,true);if(r){t.selectRangeIndexes(e,r)}}};this.populateAttributes=function(e,t,i){var s=this;e.children.forEach(function(e){switch(e.getType()){case Scule.parser.arities.variable:if(e.getFirstChild().getType()==Scule.parser.arities.selective){e.children.forEach(function(r){s.processClauses(e.getSymbol(),r,t,i)})}else{s.processClauses(e.getSymbol(),e,t,i)}break;case Scule.parser.arities.selective:throw"sub-expressions cannot use indexes";break}})};this.processClauses=function(e,t,i,s){t.children.forEach(function(t){switch(t.getType()){case Scule.parser.arities.range:i.put(e,true);break;case Scule.parser.arities.operand:case Scule.parser.arities.binary:s.put(e,true);break}})};this.selectExactIndexes=function(e,t){var i=new Scule.parser.classes.QueryIndex(t.$index.getName());i.index=t.$index;i.range=false;var s={};var r=[];for(var n=0;n<e.children.length;n++){var a=e.children[n];var l=a.getSymbol();if(l in t.$attr&&t.$attr[l]){var u=a.children;if(a.getFirstChild().getType()==Scule.parser.arities.selective){u=a.getFirstChild().children}for(var c=0;c<u.length;c++){if(u[c].getSymbol()=="$eq"){s[l]=u[c].getFirstChild().getSymbol();r.push({i_index:n,j_index:c,carray:u,parray:e.children});break}}}}if(r.length!==t.$index.astrings.length){return}else{r=r.reverse();r.forEach(function(e){e.carray.splice(e.j_index,1);if(e.carray.length===0){e.parray.splice(e.i_index,1)}})}s=Scule.global.functions.objectValues(Scule.global.functions.sortObjectKeys(s));e.children.unshift(i);i.args=s.join(",")};this.selectRangeIndexes=function(e,t){if(t.$index.astrings.length>1){return}var i=new Scule.parser.classes.QueryIndex(t.$index.getName());i.index=t.$index;i.range=true;var s=[];var r=0;var n=[null,null];var a=[null,null];for(var l=0;l<e.children.length;l++){var u=e.children[l];var c=u.getSymbol();if(c in t.$attr&&t.$attr[c]){if(!u.getFirstChild()){continue}r++;var o=u.getFirstChild().children;for(var h=0;h<o.length;h++){var f=o[h];var d=false;switch(f.getSymbol()){case"$gt":d=true;n[0]=f.getFirstChild().getSymbol();a[0]=false;break;case"$gte":d=true;n[0]=f.getFirstChild().getSymbol();a[0]=true;break;case"$lt":d=true;n[1]=f.getFirstChild().getSymbol();a[1]=false;break;case"$lte":d=true;n[1]=f.getFirstChild().getSymbol();a[1]=true;break}if(d){s.push({i_index:l,j_index:h,carray:o,parray:e.children})}}}}if(s.length===0||r<t.$index.astrings.length){return}else{s=s.reverse();s.forEach(function(e){e.carray.splice(e.j_index,1);if(e.carray.length===0){e.parray.splice(e.i_index,1)}})}e.children.unshift(i);i.args=n.concat(a)}};Scule.builder.classes.ProgramInstruction=function(e,t){this.opcode=e;this.args=t;this.toByteCode=function(){Scule.builder.variables.line++;return[Scule.builder.instructions.table[this.opcode],t]};this.explain=function(){var e=[];this.args.forEach(function(t){if(!t){return}if(Scule.global.functions.isScalar(t)){e.push(t)}else{if("getName"in t){e.push(t.getName())}else{e.push(t)}}});var t="";if(e.length>0){try{t=JSON.stringify(e)}catch(i){t=e[0].getName()}}console.log(Scule.builder.variables.line++ +" "+this.opcode+" "+t)}};Scule.builder.classes.ProgramBlock=function(e){this.operand=e;this.children=[];this.instructions=[];this.scope=Scule.getLIFOStack();this.scope.push(this);this.addSubBlock=function(e){this.children.push(e)};this.addInstruction=function(e,t){this.scope.peek().instructions.push(new Scule.builder.classes.ProgramInstruction(e,t))};this.startBlock=function(){var e=new Scule.builder.classes.ProgramBlock;this.scope.peek().addSubBlock(e);this.scope.push(e)};this.startHeadBlock=function(){var e=new Scule.builder.classes.ProgramBlock("head");this.scope.peek().addSubBlock(e);this.scope.push(e)};this.startScanBlock=function(e,t){this.scope.peek().addInstruction("scan",[e,t])};this.startFindBlock=function(e,t){this.scope.peek().addInstruction("find",[e,t])};this.startRangeBlock=function(e,t){this.scope.peek().addInstruction("range",[e,t])};this.startAndBlock=function(){var e=new Scule.builder.classes.ProgramAndBlock;this.scope.peek().addSubBlock(e);this.scope.push(e)};this.startOrBlock=function(){var e=new Scule.builder.classes.ProgramOrBlock;this.scope.peek().addSubBlock(e);this.scope.push(e)};this.startLoopBlock=function(){var e=new Scule.builder.classes.ProgramLoopBlock;this.scope.peek().addSubBlock(e);this.scope.push(e)};this.stopBlock=function(){this.scope.pop()};this.getOperand=function(){return this.operand};this.getChildren=function(){return this.children};this.toByteCode=function(){var e=[];if(this.children.length>0){this.children.forEach(function(t){e=e.concat(t.toByteCode())})}else{this.instructions.forEach(function(t){e.push(t.toByteCode())})}return e};this.explain=function(){if(this.children.length>0){this.children.forEach(function(e){e.explain()})}else{this.instructions.forEach(function(e){e.explain()})}}};Scule.builder.classes.ProgramOrBlock=function(){Scule.builder.classes.ProgramBlock.call(this,"or");this.toByteCode=function(){var e=[];this.children.forEach(function(t){e=e.concat(t.toByteCode())});if(this.children.length>1){e.push([2,[this.children.length]]);Scule.builder.variables.line++}return e};this.explain=function(){this.children.forEach(function(e){e.explain()});if(this.children.length>1){console.log(Scule.builder.variables.line++ +" or ["+this.children.length+"]")}}};Scule.builder.classes.ProgramAndBlock=function(){Scule.builder.classes.ProgramBlock.call(this,"and");this.toByteCode=function(){var e=0;var t=[];this.instructions.forEach(function(i){t.push(i.toByteCode());e++});this.children.forEach(function(i){t=t.concat(i.toByteCode());e++});if(e>1){t.push([1,[e]]);Scule.builder.variables.line++}return t};this.explain=function(){var e=0;this.instructions.forEach(function(t){t.explain();e++});this.children.forEach(function(t){t.explain();e++});if(e>1){console.log(Scule.builder.variables.line++ +" and ["+e+"]")}}};Scule.builder.classes.ProgramLoopBlock=function(){Scule.builder.classes.ProgramBlock.call(this,"loop");this.toByteCode=function(){var e=[];var t=Scule.builder.variables.line;e.push([39,[]]);Scule.builder.variables.line++;this.children.forEach(function(t){e=e.concat(t.toByteCode())});e.push([32,[]]);Scule.builder.variables.line++;e.push([37,[Scule.builder.variables.line+2]]);Scule.builder.variables.line++;e.push([38,[t]]);Scule.builder.variables.line++;return e};this.explain=function(){var e=Scule.builder.variables.line;console.log(Scule.builder.variables.line++ +" read");this.children.forEach(function(e){e.explain()});console.log(Scule.builder.variables.line++ +" shift");console.log(Scule.builder.variables.line++ +" jump ["+(Scule.builder.variables.line+1)+"]");console.log(Scule.builder.variables.line++ +" goto ["+e+"]")}};Scule.builder.classes.Program=function(){this.bytecode=[];Scule.builder.classes.ProgramBlock.call(this);this.clearByteCode=function(){Scule.builder.variables.line=0;this.bytecode=[]};this.toByteCode=function(){return this.bytecode}};Scule.builder.classes.ProgramBuilder=function(){this.program=new Scule.builder.classes.Program;this.buildHead=function(){var e=this.program.getChildren();var t;for(var i=0;i<e.length;i++){t=e[i];if(t.getOperand()=="head"){this.program.bytecode=this.program.bytecode.concat(t.toByteCode());break}}this.program.bytecode.push([35,[]]);Scule.builder.variables.line++;this.program.bytecode.push([33,[]]);Scule.builder.variables.line++};this.explainHead=function(){var e=this.program.getChildren();var t;for(var i=0;i<e.length;i++){t=e[i];if(t.getOperand()=="head"){t.explain();break}}console.log(Scule.builder.variables.line++ +" intersect");console.log(Scule.builder.variables.line++ +" store")};this.buildBody=function(){var e=this.program.getChildren();var t=0;var i;for(var s=0;s<e.length;s++){i=e[s];if(i.getOperand()!="head"){t++;this.program.bytecode=this.program.bytecode.concat(i.toByteCode())}}if(t===0){this.program.bytecode.push([40,[]]);Scule.builder.variables.line++}};this.explainBody=function(){var e=this.program.getChildren();var t=0;var i;for(var s=0;s<e.length;s++){i=e[s];if(i.getOperand()!="head"){t++;i.explain()}}if(t===0){console.log(Scule.builder.variables.line++ +" transpose")}};this.buildTail=function(){this.program.bytecode.push([0,[]]);Scule.builder.variables.line++};this.explainTail=function(){console.log(Scule.builder.variables.line++ +" halt")};this.getProgram=function(){return this.program};this.explainProgram=function(){Scule.builder.variables.line=0;this.program.clearByteCode();this.explainHead();this.explainBody();this.explainTail()};this.buildProgram=function(){Scule.builder.variables.line=0;this.program.clearByteCode();this.buildHead();this.buildBody();this.buildTail()}};Scule.builder.classes.ProgramDirector=function(){this.builder=null;
this.setProgramBuilder=function(e){this.builder=e};this.getProgram=function(){return this.builder.getProgram()};this.buildProgram=function(){this.builder.buildProgram()};this.explainProgram=function(){this.builder.explainProgram()}};Scule.builder.classes.AbstractSyntaxTreeCompiler=function(){this.compile=function(e,t,i,s){if(!t){t={}}var r=false;var n=e.getRoot();var a=new Scule.builder.classes.ProgramDirector;a.setProgramBuilder(new Scule.builder.classes.ProgramBuilder);var l=a.getProgram();l.startHeadBlock();if(!n.hasChildren()||n.getFirstChild().getType()!==Scule.parser.arities.index){l.addInstruction("scan",[i]);l.stopBlock();r=n.children.length>0}else{var u=0;for(;u<n.children.length;u++){var c=n.children[u];if(c.getType()!==Scule.parser.arities.index){break}else{if(c.range){l.startRangeBlock(c.index,c.args)}else{l.startFindBlock(c.index,c.args)}}}l.stopBlock();r=u<n.children.length}var o=function(e){e.children.forEach(function(t){switch(t.getType()){case Scule.parser.arities.selective:t.children.forEach(function(t){h(e,t)});break;case Scule.parser.arities.array:case Scule.parser.arities.range:case Scule.parser.arities.binary:case Scule.parser.arities.negative:h(e,t);break}})};var h=function(e,t){var i=[t.children[0].getSymbol()];i.unshift(e.getSymbol());l.addInstruction(Scule.builder.instructions.mapping[t.getSymbol()],i)};var f=function(e){e.children.forEach(function(e){switch(e.getType()){case Scule.parser.arities.selective:if(e.getSymbol()=="$or"){l.startOrBlock()}else{l.startAndBlock()}f(e);l.stopBlock();break;case Scule.parser.arities.variable:o(e);break;case Scule.parser.arities.expression:l.startAndBlock();f(e);l.stopBlock();break}})};if(r){l.startLoopBlock()}l.startAndBlock();f(n);l.stopBlock();if(r){l.stopBlock()}l.startBlock();if("$sort"in t){for(var d in t.$sort){if(t.$sort.hasOwnProperty(d)){l.addInstruction("sort",[d,t.$sort[d]]);break}}}if("$limit"in t){l.addInstruction("limit",[t.$limit])}l.stopBlock();if(!r){l.startBlock();l.addInstruction("transpose",[]);l.stopBlock()}if(s){a.explainProgram()}a.buildProgram();return a.getProgram()}};Scule.builder.classes.QueryCompiler=function(){this.cache=Scule.getLRUCache(30);this.parser=Scule.getQueryParser();this.visitor=new Scule.builder.classes.QueryTreeIndexSelectionVisitor;this.compiler=new Scule.builder.classes.AbstractSyntaxTreeCompiler;this.compileMutate=function(e,t){var i=[];i.push([Scule.builder.instructions.table.rread,[]]);for(var s in e){if(e.hasOwnProperty(s)){if(!(Scule.builder.instructions.mapping[s]in Scule.builder.instructions.table)){throw s+" is an unrecognized operator"}for(var r in e[s]){if(e[s].hasOwnProperty(r)){var n=Scule.builder.instructions.table[Scule.builder.instructions.mapping[s]];i.push([n,[Scule.global.functions.parseAttributes(r),e[s][r]]])}}}}i.push([Scule.builder.instructions.table.rindex,[t]]);i.push([Scule.builder.instructions.table["goto"],[0]]);return i};this.explainMutate=function(e,t){var i=0;console.log(i++ +" rread");for(var s in e){if(e.hasOwnProperty(s)){if(!(Scule.builder.instructions.mapping[s]in Scule.builder.instructions.table)){throw s+" is an unrecognized operator"}for(var r in e[s]){if(e[s].hasOwnProperty(r)){console.log(i++ +" "+Scule.builder.instructions.mapping[s]+" "+r+", "+JSON.stringify(e[s][r]))}}}}console.log(i++ +" rindex "+t.getName());console.log(i++ +" goto 0")};this.compileQuery=function(e,t,i){var s=Scule.md5.hash(JSON.stringify(e));if(this.cache.contains(s)){return this.cache.get(s).toByteCode()}var r=function(e){e.children.forEach(function(e){r(e)})};this.visitor.setCollection(i);var n=this.parser.parseQuery(e);n.accept(this.visitor);var a=this.compiler.compile(n,t,i);this.cache.put(s,a);return a.toByteCode()};this.explainQuery=function(e,t,i){this.visitor.setCollection(i);var s=this.parser.parseQuery(e);s.accept(this.visitor);var r=this.compiler.compile(s,t,i,true)}};Scule.getQueryTreeIndexSelectionVisitor=function(e){return new Scule.builder.classes.QueryTreeIndexSelectionVisitor(e)};Scule.getAbstractSyntaxTreeCompiler=function(){return new Scule.builder.classes.AbstractSyntaxTreeCompiler};Scule.getProgramDirector=function(){return new Scule.builder.classes.ProgramDirector};Scule.getProgramBuilder=function(){return new Scule.builder.classes.ProgramBuilder};Scule.getQueryCompiler=function(){return new Scule.builder.classes.QueryCompiler}})();(function(){"use strict";Scule.vm.classes.VirtualMachine=function(){this.running=false;this.upsert=false;this.ipointer=0;this.dpointer=0;this.registers=[];this.instructions={};this.stack=Scule.getLIFOStack();this.result=[];this.reset=function(){this.running=false;this.upsert=false;this.ipointer=0;this.dpointer=0;this.registers=[];this.result=[];this.stack.clear()};this.halt=function(){this.running=false};this.resume=function(){this.running=true;this.execute()};this.execute=function(e,t,i){if(!e){e=this.registers[3]}else{this.registers[3]=e}this.running=true;while(this.running){this.executeInstruction(e[this.ipointer])}this.running=false;if(t){this.dpointer=0;this.ipointer=0;this.running=true;this.upsert=i;while(this.running){this.executeInstruction(t[this.ipointer])}}return this.result};this.registerInstruction=function(e,t){this.instructions[e]=t};this.registerInstruction(0,function(e,t){e.running=false;e.ipointer++});this.registerInstruction(26,function(e,t){e.running=false;e.ipointer++});this.registerInstruction(36,function(e,t){e.running=true;e.ipointer++});this.registerInstruction(28,function(e,t){var i=t[1][0].findAll();if(i.length===0){e.running=false}e.stack.push(i);e.ipointer++});this.registerInstruction(29,function(e,t){var i=t[1][1];e.stack.push(t[1][0].range(i[0],i[1],i[2],i[3]));e.ipointer++});this.registerInstruction(27,function(e,t){e.stack.push(t[1][0].search(t[1][1]));e.ipointer++});this.registerInstruction(33,function(e,t){e.registers[0]=e.stack.pop();e.ipointer++});this.registerInstruction(40,function(e,t){e.result=e.registers[0];e.ipointer++});this.registerInstruction(39,function(e,t){e.registers[1]=e.registers[0][e.dpointer];e.dpointer++;e.ipointer++});this.registerInstruction(32,function(e,t){if(e.stack.pop()===true){e.result.push(e.registers[1])}e.ipointer++});this.registerInstruction(35,function(e,t){if(e.stack.getLength()===1){e.ipointer++;return}var i=[];while(!e.stack.isEmpty()){i.push(e.stack.pop())}var s=Scule.vm.functions.intersection(i);if(s.length===0){e.running=false}e.stack.push(s);e.ipointer++});this.registerInstruction(1,function(e,t){var i=t[1][0];var s=null;do{if(s===null){s=e.stack.pop()}else{s=s&&e.stack.pop()}i--}while(i>0);e.stack.push(s);e.ipointer++});this.registerInstruction(2,function(e,t){var i=t[1][0];var s=null;do{if(s===null){s=e.stack.pop()}else{s=s||e.stack.pop()}i--}while(i>0);e.stack.push(s);e.ipointer++});this.registerInstruction(38,function(e,t){e.ipointer=t[1][0]});this.registerInstruction(37,function(e,t){if(e.dpointer>=e.registers[0].length){e.ipointer=t[1][0];return}e.ipointer++});this.registerInstruction(12,function(e,t){var i=e.registers[1];var s=Scule.global.functions.traverse(t[1][0],i);if(t[1][1]instanceof RegExp){e.stack.push(t[1][1].test(s))}else{e.stack.push(s==t[1][1])}e.ipointer++});this.registerInstruction(13,function(e,t){var i=e.registers[1];var s=Scule.global.functions.traverse(t[1][0],i);e.stack.push(s!==t[1][1]);e.ipointer++});this.registerInstruction(7,function(e,t){var i=e.registers[1];var s=Scule.global.functions.traverse(t[1][0],i);e.stack.push(s>t[1][1]);e.ipointer++});this.registerInstruction(8,function(e,t){var i=e.registers[1];var s=Scule.global.functions.traverse(t[1][0],i);e.stack.push(s>=t[1][1]);e.ipointer++});this.registerInstruction(5,function(e,t){var i=e.registers[1];var s=Scule.global.functions.traverse(t[1][0],i);e.stack.push(s<t[1][1]);e.ipointer++});this.registerInstruction(6,function(e,t){var i=e.registers[1];var s=Scule.global.functions.traverse(t[1][0],i);e.stack.push(s<=t[1][1]);e.ipointer++});this.registerInstruction(10,function(e,t){var i=e.registers[1];var s=Scule.global.functions.traverse(t[1][0],i);if(s===undefined){e.stack.push(false)}else{e.stack.push(t[1][1].contains(s))}e.ipointer++});this.registerInstruction(11,function(e,t){var i=e.registers[1];var s=Scule.global.functions.traverse(t[1][0],i);if(s===undefined){e.stack.push(true)}else{e.stack.push(!t[1][1].contains(s))}e.ipointer++});this.registerInstruction(14,function(e,t){var i=e.registers[1];var s=Scule.global.functions.traverse(t[1][0],i);e.stack.push(Scule.global.functions.sizeOf(s)==t[1][1]);e.ipointer++});this.registerInstruction(15,function(e,t){var i=e.registers[1];var s=Scule.global.functions.traverse(t[1][0],i);if(t[1][1]){e.stack.push(s!==undefined)}else{e.stack.push(s===undefined)}e.ipointer++});this.registerInstruction(9,function(e,t){var i=e.registers[1];var s=Scule.global.functions.traverse(t[1][0],i);if(!Scule.global.functions.isArray(s)){e.stack.push(false)}else{var r=t[1][1];if(s.length<r.getLength()){e.stack.push(false)}else{var n=Scule.getHashTable();var a=r.getKeys();a.forEach(function(e){n.put(e,false)});for(var l=0;l<s.length;l++){if(n.contains(s[l])){n.remove(s[l])}}e.stack.push(n.getLength()===0)}}e.ipointer++});this.registerInstruction(41,function(e,t){if(t[1][0]<e.result.length){e.result=e.result.splice(0,t[1][0])}e.ipointer++});this.registerInstruction(42,function(e,t){Scule.global.functions.sort(t[1][1],e.result,t[1][0]);e.ipointer++});this.registerInstruction(43,function(e,t){if(e.dpointer>=e.result.length){e.halt()}e.registers[1]=e.result[e.dpointer];e.dpointer++;e.ipointer++});this.registerInstruction(18,function(e,t){var i=e.registers[1];var s=Scule.global.functions.traverseObject(t[1][0],i);var r=s[0];var n=s[1];if(!(r in n)){if(e.upsert===true){n[r]=t[1][1]}}else{n[r]=t[1][1]}e.ipointer++});this.registerInstruction(19,function(e,t){var i=e.registers[1];var s=Scule.global.functions.traverseObject(t[1][0],i);var r=s[0];var n=s[1];if(r in n){delete n[r]}e.ipointer++});this.registerInstruction(20,function(e,t){var i=e.registers[1];var s=Scule.global.functions.traverseObject(t[1][0],i);var r=s[0];var n=s[1];if(!(r in n)){if(e.upsert){n[r]=t[1][1]}}else{if(Scule.global.functions.isInteger(n[r])||Scule.global.functions.isDouble(n[r])){n[r]+=t[1][1]}}e.ipointer++});this.registerInstruction(21,function(e,t){var i=e.registers[1];var s=Scule.global.functions.traverseObject(t[1][0],i);var r=s[0];var n=s[1];if(r in n&&Scule.global.functions.isArray(n[r])){var a=t[1][1];for(var l=0;l<n[r].length;l++){if(n[r][l]==a){n[r].splice(l,1);l--}}}e.ipointer++});this.registerInstruction(22,function(e,t){var i=e.registers[1];var s=Scule.global.functions.traverseObject(t[1][0],i);var r=s[0];var n=s[1];if(r in n&&Scule.global.functions.isArray(n[r])){var a=t[1][1];if(!Scule.global.functions.isArray(a)){throw"the $pullAll operator requires an associated array as an operand"}var l=Scule.getHashTable();a.forEach(function(e){l.put(e,true)});for(var u=0;u<n[r].length;u++){if(l.contains(n[r][u])){n[r].splice(u,1);u--}}}e.ipointer++});this.registerInstruction(23,function(e,t){var i=e.registers[1];var s=Scule.global.functions.traverseObject(t[1][0],i);var r=s[0];var n=s[1];if(r in n&&Scule.global.functions.isArray(n[r])){n[r].pop()}e.ipointer++});this.registerInstruction(24,function(e,t){var i=e.registers[1];var s=Scule.global.functions.traverseObject(t[1][0],i);var r=s[0];var n=s[1];if(!(r in n)&&e.upsert){n[r]=t[1][1]}else{if(Scule.global.functions.isArray(n[r])){n[r].push(t[1][1])}}e.ipointer++});this.registerInstruction(25,function(e,t){var i=e.registers[1];var s=Scule.global.functions.traverseObject(t[1][0],i);var r=s[0];var n=s[1];if(!(r in n)&&e.upsert){n[r]=t[1][1]}else{var a=t[1][1];if(!Scule.global.functions.isArray(a)){throw"the $pushAll operator requires an associated array as an operand"}if(Scule.global.functions.isArray(n[r])){n[r]=n[r].concat(a)}}e.ipointer++});this.registerInstruction(44,function(e,t){Scule.vm.functions.updateIndexes(e.registers[1],t[1][0]);e.ipointer++});this.registerInstruction(16,function(e,t){var i=e.registers[1];var s=Scule.global.functions.traverseObject(Scule.global.functions.parseAttributes(t[1][0]),i);if(s.length<2||!("loc"in s[1])){e.stack.push(false)}else{s=s[1].loc;if(!("lat"in s)||!("lon"in s)){e.stack.push(false)}else{var r=t[1][1];var n=Math.sqrt(Math.pow(r.lat-s.lat,2)+Math.pow(r.lon-s.lon,2));if(n<=r.distance){i=Scule.global.functions.cloneObject(i);i._meta={distance:n};e.registers[1]=i;e.stack.push(true)}else{e.stack.push(false)}}}e.ipointer++});this.registerInstruction(17,function(e,t){var i=e.registers[1];var s=Scule.global.functions.traverseObject(Scule.global.functions.parseAttributes(t[1][0]),i);if(s.length<2||!("loc"in s[1])){e.stack.push(false)}else{s=s[1].loc;var r=t[1][1];var n=r.distance;if(!("lat"in s)||!("lon"in s)){e.stack.push(false)}else{var a=Math.acos(Math.sin(s.lat)*Math.sin(r.lat)+Math.cos(s.lat)*Math.cos(r.lat)*Math.cos(r.lon-s.lon))*6371;if(a<=n){i=Scule.global.functions.cloneObject(i);i._meta={distance:a};e.registers[1]=i;e.stack.push(true)}else{e.stack.push(false)}}}e.ipointer++});this.executeInstruction=function(e){this.instructions[e[0]](this,e)}};Scule.vm.functions.updateIndexes=function(e,t){t.indices.forEach(function(t){t.remove(e);t.index(e)})};Scule.vm.functions.intersection=function(e){if(e.length===1){return e[0]}var t=Scule.getHashTable();var i=null;e.forEach(function(e){if(!i||e.length<i.length){i=e}});if(!i){return[]}i.forEach(function(e){t.put(Scule.global.functions.getObjectId(e),{c:1,o:e})});var s=[];var r=e.length;for(var n=0;n<r;n++){if(e[n]==i){continue}e[n].forEach(function(e){var i=t.get(Scule.global.functions.getObjectId(e));if(i){i.c++;if(i.c==r){s.push(e)}}})}return s};Scule.getVirtualMachine=function(){return new Scule.vm.classes.VirtualMachine}})();(function(){"use strict";Scule.db.classes.HashBucketTable=function(){Scule.datastructures.classes.HashTable.call(this);this.insert=function(e,t){var i;if(!this.contains(e)){i=Scule.getHashTable();i.put(Scule.global.functions.getObjectId(t),t);this.put(e,i)}else{i=this.get(e);i.put(Scule.global.functions.getObjectId(t),t)}return true}};Scule.db.classes.BPlusTreeHashingLeafNode=function(e,t){Scule.datastructures.classes.BPlusTreeLeafNode.call(this,e,t);this.insert=function(e,t){var i;var s=this.indexSearch(e);if(s==this.data.length){i=Scule.getHashTable();i.put(Scule.global.functions.getObjectId(t,true),t);this.data.push({key:e,value:i})}else{var r=this.data[s];if(r.key==e){r.value.put(Scule.global.functions.getObjectId(t,true),t)}else if(r.key<e){i=Scule.getHashTable();i.put(Scule.global.functions.getObjectId(t,true),t);this.data.splice(s+1,0,{key:e,value:i})}else{i=Scule.getHashTable();i.put(Scule.global.functions.getObjectId(t,true),t);this.data.splice(s,0,{key:e,value:i})}}if(i){this.lookup.put(e,{key:e,value:i})}return this.split()};this.split=function(){if(this.data.length<=this.order){return null}var e=Math.floor(this.data.length/2);var t=new Scule.db.classes.BPlusTreeHashingLeafNode(this.getLeft());t.setOrder(this.getOrder());t.setMergeThreshold(this.getMergeThreshold());t.data=this.data.splice(0,e);var i=new Scule.db.classes.BPlusTreeHashingLeafNode(null,this.getRight());i.setOrder(this.getOrder());i.setMergeThreshold(this.getMergeThreshold());i.data=this.data.splice(0,e+1);t.setRight(i);if(this.getLeft()){this.getLeft().setRight(t)}i.setLeft(t);if(this.getRight()){this.getRight().setLeft(i)}return{left:t,key:i.data[0].key,right:i}};this.range=function(e,t,i,s){if(s===undefined){s=false}if(i===undefined){i=false}if(e===undefined){e=null}if(t===undefined){t=null}var r=this;var n=null;if(i&&s){n=function(e,t,i,s,r){if(e===null){if(i<=t){s=s.concat(r)}}else if(t===null){if(i>=e){s=s.concat(r)}}else{if(i>=e&&i<=t){s=s.concat(r)}}return s}}else if(i){n=function(e,t,i,s,r){if(e===null){if(i<t){s=s.concat(r)}}else if(t===null){if(i>=e){s=s.concat(r)}}else{if(i>=e&&i<t){s=s.concat(r)}}return s}}else{n=function(e,t,i,s,r){if(e===null){if(i<=t){s=s.concat(r)}}else if(t===null){if(i>e){s=s.concat(r)}}else{if(i>e&&i<=t){s=s.concat(r)}}return s}}var a=[];e:while(r){var l=r.data;var u=r.indexSearch(e);var c=t===null||t===undefined?l.length-1:r.indexSearch(t);if(c>=l.length){c=l.length-1}if(u<=l.length){for(var o=u;o<=c;o++){if(t!==null&&l[o].key>t){break e}a=n(e,t,l[o].key,a,l[o].value.getValues())}}r=r.getRight()}return a};this.toArray=function(){var e={type:"hashing-leaf"};for(var t=0;t<this.data.length;t++){e[t+":"+this.data[t].key]=this.data[t].value}return e}};Scule.db.classes.BPlusHashingTree=function(e,t){Scule.datastructures.classes.BPlusTree.call(this,e,t);this.root=new Scule.db.classes.BPlusTreeHashingLeafNode;this.root.setOrder(this.order);this.root.setMergeThreshold(this.threshold);this.clear=function(){this.root=new Scule.db.classes.BPlusTreeHashingLeafNode;this.root.setOrder(this.order);this.root.setMergeThreshold(this.threshold)}};Scule.db.classes.Index=function(){this.attributes={};this.astrings=Scule.getHashTable();this.leaves=Scule.getHashTable();this.structure=null;this.type=null;this.setAttribtues=function(e){this.attributes=e;this.attributes=Scule.global.functions.sortObjectKeys(this.attributes)};this.parseAttributes=function(e){this.populateAttributeStrings(e);this.attributes=Scule.global.functions.parseAttributes(e);this.attributes=Scule.global.functions.sortObjectKeys(this.attributes)};this.populateAttributeStrings=function(e){var t=this;if(!Scule.global.functions.isArray(e)){e=e.split(",")}e.forEach(function(e){t.astrings.put(e,true)})};this.resetAttributes=function(){this.attributes={};this.clear()};this.getType=function(){return this.type};this.getName=function(){return this.astrings.getKeys().sort().join(",")};this.applies=function(e,t){if(t&&this.getType()==Scule.global.constants.INDEX_TYPE_HASH){return false}if(e.length<this.astrings.getLength()){return false}var i={$partial:false,$none:true,$range:t,$attr:{},$index:this};var s=this;e.forEach(function(e){if(s.astrings.contains(e)){i.$attr[e]=true;i.$none=false}else{if(!i.$partial){i.$partial=true}i.$attr[e]=false}});if(i.$none){return false}return i};this.generateIndexKey=function(e){var t=Scule.global.functions.searchObject(this.attributes,e);if(t.length===1){return t[0]}return t.join(",")};this.index=function(e){if(!this.structure){return false}var t=Scule.global.functions.getObjectId(e,true);var i=this.generateIndexKey(e);this.structure.insert(i,e);var s=this.structure.search(i);this.leaves.put(t,{table:s,key:i});return true};this.remove=function(e){if(!this.structure){return false}var t=Scule.global.functions.getObjectId(e,true);if(!this.leaves.contains(t)){return false}var i=this.leaves.get(t);i.table.remove(t);if(i.table.getLength()===0){this.structure.remove(i.key)}return true};this.removeKey=function(e){if(!this.structure){return false}var t=this.structure.search(e);if(t&&t.length>0){this.structure.remove(e);for(var i in t.table){if(t.table.hasOwnProperty(i)){this.leaves.remove(Scule.global.functions.getObjectId(t.get(i),true))}}}return true};this.search=function(e){if(this.structure){var t=this.structure.search(e);if(t){return t.getValues()}}return[]};this.range=function(e,t,i,s){if(this.structure){return this.structure.range(e,t,i,s)}return false};this.clear=function(){if(this.structure){this.structure.clear();return true}return false};this.getLength=function(){return this.leaves.length}};Scule.db.classes.BPlusTreeIndex=function(e){Scule.db.classes.Index.call(this);if(!e){e=100}this.structure=new Scule.db.classes.BPlusHashingTree(e);this.type=Scule.global.constants.INDEX_TYPE_BTREE};Scule.db.classes.HashTableIndex=function(){Scule.db.classes.Index.call(this);this.structure=new Scule.db.classes.HashBucketTable;this.type=Scule.global.constants.INDEX_TYPE_HASH;this.range=function(e,t,i,s){throw"HashTable type indices to not support range query operations"}};Scule.db.classes.SimpleCryptographyProvider=function(){this.signString=function(e,t,i){return Scule.sha1.hash(Scule.sha1.hash(e+t)+i)};this.signObject=function(e,t,i){e._sig=i;return this.signString(JSON.stringify(e),t,i)};this.signJSONString=function(e,t,i){return this.signString(JSON.stringify(e),t,i)};this.verifyObjectSignature=function(e,t,i){var s=e._sig;var r=this.signObject(e,t,i);return s==r}};Scule.db.classes.StorageEngine=function(e){this.configuration=e;this.crypto=null;this.setConfiguration=function(e){this.configuration=e};this.getConfiguration=function(){return this.configuration};this.setCryptographyProvider=function(e){this.crypto=e};this.getCryptographyProvider=function(){return this.crypto};this.write=function(e,t,i){throw"function not implemented in abstract class"};this.read=function(e,t){throw"function not implemented in abstract class"}};Scule.db.classes.DummyStorageEngine=function(e){Scule.db.classes.StorageEngine.call(this,e);this.write=function(e,t,i){if(i){i(t)}};this.read=function(e,t){if(t){t()}}};Scule.db.classes.MemoryStorageEngine=function(e){Scule.db.classes.StorageEngine.call(this,e);this.setCryptographyProvider(new Scule.db.classes.SimpleCryptographyProvider);this.storage={};this.write=function(e,t,i){if(!t._salt){t._salt=Scule.sha1.hash((new Date).getTime()+"")}t._sig=this.crypto.signObject(t,this.configuration.secret,t._salt);this.storage["__scule_collection__"+e]=JSON.stringify(t);if(i){i(t)}};this.read=function(e,t){if(!("__scule_collection__"+e in this.storage)){var i={_sig:null,_salt:Scule.sha1.hash((new Date).getTime()+""),_version:2,_name:e,_objects:{}};i._sig=this.crypto.signObject(i,this.configuration.secret,i._salt);this.storage["__scule_collection__"+e]=JSON.stringify(i)}var s=this.storage["__scule_collection__"+e];var r=JSON.parse(s);if(this.crypto.verifyObjectSignature(r,this.configuration.secret,r._salt)===false){throw JSON.stringify({event:"SculeDataTampered",filename:this.configuration.collection})}delete r._sig;if(t){t(r)}}};Scule.db.classes.LocalStorageStorageEngine=function(e){Scule.db.classes.StorageEngine.call(this,e);this.setCryptographyProvider(new Scule.db.classes.SimpleCryptographyProvider);if(!window||!window.hasOwnProperty("localStorage")&&window.localStorage!==null){throw JSON.stringify({event:"SculeLocalStorageError",message:"Local storage is not available on this device"})}this.write=function(e,t,i){if(!t._salt){t._salt=Scule.sha1.hash((new Date).getTime()+"")}try{t._sig=this.crypto.signObject(t,this.configuration.secret,t._salt);localStorage.setItem("__scule_collection__"+e,JSON.stringify(t));if(i){i(t)}}catch(s){throw JSON.stringify({event:"SculeLocalStorageError",message:"Storage quota exceeded for origin",collection:this.configuration.collection})}};this.read=function(e,t){var i=localStorage.getItem("__scule_collection__"+e);if(!i){throw JSON.stringify({event:"SculeLocalStorageError",message:"Unable to load collection from local storage",collection:this.configuration.collection})}var s=JSON.parse(i);if(this.crypto.verifyObjectSignature(s,this.configuration.secret,s._salt)===false){throw JSON.stringify({event:"SculeDataTampered",filename:this.configuration.collection})}delete s._sig;if(t){t(s)}}};Scule.db.classes.ObjectId=function(e){if(e===undefined){var t=Math.floor((new Date).getTime()/1e3).toString(16);var i=Scule.md5.hash(Scule.global.functions.getMACAddress()).substring(0,6);var s=Scule.global.functions.randomFromTo(1e3,9999).toString(16);while(s.length<4){s="0"+s}var r=Scule.global.functions.randomFromTo(1e5,999999).toString(16);while(r.length<6){r="0"+r}e=t+i+s+r}this.id=e;this.$type="id";this.toString=function(){return this.id.toString()}};Scule.db.classes.ObjectDate=function(e,t){if(e===undefined&&t===undefined){var i=(new Date).getTime().toString();e=parseInt(i.substring(0,10),10);t=parseInt(i.substring(10),10)}this.ts=parseInt(e+t,10);this.sec=e;this.usec=t;this.$type="date";this.getTimestamp=function(){return this.ts};this.getSeconds=function(){return this.sec};this.getMicroSeconds=function(){return this.usec}};Scule.db.classes.DBRef=function(e,t){if(e===undefined||t===undefined){throw"illegal object reference"}this.ref=e;this.id=new Scule.db.classes.ObjectId(t);this.$type="dbref";this.getRef=function(){return this.ref};this.getId=function(){return this.id};this.resolve=function(){return this.resolveReference()};this.resolveReference=function(){var e=Scule.factoryCollection(this.ref);return e.findOne(this.id)}};Scule.db.classes.Collection=function(e){this.documents=Scule.getHashTable();this.compiler=Scule.getQueryCompiler();this.vm=Scule.getVirtualMachine();this.version=2;this.lastId=null;this.name=e;this.autoCommit=false;this.isOpen=false;this.storage=null;this.indices=[];this.setStorageEngine=function(e){this.storage=e};this.ensureIndex=function(e,t,i){var s;switch(e){case Scule.global.constants.INDEX_TYPE_BTREE:if(!i){i={order:100}}s=new Scule.db.classes.BPlusTreeIndex(i.order);s.parseAttributes(t);break;case Scule.global.constants.INDEX_TYPE_HASH:s=new Scule.db.classes.HashTableIndex;s.parseAttributes(t);break}if(s){var r=false;var n=s.astrings.length;for(var a=0;a<this.indices.length;a++){if(n>this.indices[a].astrings.length){this.indices.splice(a,0,s);r=true;break}}if(!r){var l=this.findAll();l.forEach(function(e){s.index(e)});this.indices.push(s)}}};this.ensureBTreeIndex=function(e,t){this.ensureIndex(Scule.global.constants.INDEX_TYPE_BTREE,e,t)};this.ensureHashIndex=function(e,t){this.ensureIndex(Scule.global.constants.INDEX_TYPE_HASH,e,t)};this.setAutoCommit=function(e){this.autoCommit=e};this.getName=function(){return this.name};this.getLength=function(){return this.documents.getLength()};this.getLastInsertId=function(){return this.lastId};this.open=function(e){if(this.isOpen){return}var t=this;this.storage.read(this.name,function(i){if(!i){return}for(var s in i._objects){if(i._objects.hasOwnProperty(s)){var r=i._objects[s];Scule.db.functions.unflattenObject(i._objects[s]);t.documents.put(Scule.global.functions.getObjectId(r,true),r);for(var n=0;n<t.indices.length;n++){t.indices[n].index(r)}}}t.isOpen=true;if(e){e(this)}})};this.commit=function(e){var t={_sig:null,_salt:null,_name:this.name,_version:this.version,_objects:this.documents.table};this.storage.write(this.name,t,e)};this.find=function(e,t,i){if(Scule.global.constants.ID_FIELD in e){return[this.findOne(e[Scule.global.constants.ID_FIELD])]}this.vm.reset();var s=this.vm.execute(this.compiler.compileQuery(e,t,this));if(i){i(s)}return s};this.explain=function(e,t,i){this.compiler.explainQuery(e,t,this);if(i){i()}};this.clear=function(e){this.documents.clear();for(var t=0;t<this.indices.length;t++){this.indices[t].clear()}if(e){e(this)}};this.findAll=function(e){var t=[];for(var i in this.documents.table){if(this.documents.table.hasOwnProperty(i)){t.push(this.documents.get(i))}}if(e){e(t)}return t};this.findOne=function(e,t){if(!Scule.global.functions.isScalar(e)){e=e.toString()}var i=null;if(this.documents.contains(e)){i=this.documents.get(e)}if(t){t(i)}return i};this.save=function(e,t){Scule.db.functions.unflattenObject(e);this.documents.put(Scule.global.functions.getObjectId(e,true),e);for(var i=0;i<this.indices.length;i++){this.indices[i].remove(e);this.indices[i].index(e)}if(this.autoCommit){this.commit()}this.lastId=Scule.global.functions.getObjectId(e);if(t){t(this.lastId)}return this.lastId};this.update=function(e,t,i,s,r){this.vm.reset();var n=this.vm.execute(this.compiler.compileQuery(e,i,this),this.compiler.compileMutate(t,this),s);if(r){r(n)}return n};this.count=function(e,t,i){var s=this.find(e,t).length;if(i){i(s)}return s};this.remove=function(e,t,i){var s=this;var r=this.find(e,t);r.forEach(function(e){s.documents.remove(Scule.global.functions.getObjectId(e));s.indices.forEach(function(t){t.remove(e)})});if(i){i(r)}return r};this.distinct=function(e,t,i){var s=this.find(t);var r={};s.forEach(function(t){if(!(t[e]in r)){r[t[e]]=0}r[t[e]]++});if(i){i(r)}return r};this.merge=function(e,t){if(!e){throw"the merge function requires a valid collection as a parameter"}var i=this;var s=e.findAll();s.forEach(function(e){if(!i.documents.contains(e._id)){i.documents.put(e._id,e)}});if(t){t(this)}return true};this.mapReduce=function(e,t,i,s){new Scule.db.classes.MapReduceHandler(e,t,i).run(this,s)}};Scule.db.classes.MapReduceHandler=function(e,t,i){this.options=i;if(!e){throw"A valid function is requires as the `map` parameter of the map/reduce operation"}if(!t){throw"A valid function is requires as the `reduce` parameter of the map/reduce operation"}if(!("out"in i)){throw"A valid output collection connection url is required as the `out` parameter of the map/reduce options object"}else{if(!("merge"in i.out)&&!("reduce"in i.out)){throw"A valid output collection connection url is required as either the `merge` or `reduce` out parameter of the map/reduce options object"}}if(!("query"in i)){i.query={}}if(!("conditions"in i)){i.conditions={}}this.map=e;this.reduce=t;this.finalize="finalize"in i?i.finalize:null;this.run=function(e,t){var i=this;var s="merge"in this.options.out;var r=Scule.factoryCollection(s?this.options.out.merge:this.options.out.reduce);var n=Scule.getHashTable();var a=function(e,t){if(!n.contains(e)){n.put(e,[])}n.get(e).push(t)};var l=e.find(this.options.query,this.options.conditions);l.forEach(function(e){i.map(e,a)});var u=null;if(s){u=Scule.factoryCollection("scule+dummy://__mr"+(new Date).getTime())}var c=Scule.getHashTable();var o=n.getKeys();o.forEach(function(e){c.put(e,i.reduce(e,n.get(e)));if(i.finalize){c.put(e,i.finalize(e,c.get(e)))}if(!s){r.save(c.get(e))}else{u.save(c.get(e))}});if(s){r.merge(u)}if(t){t(r)}return true}};Scule.db.classes.CollectionFactory=function(){this.collections=Scule.getHashTable();this.getCollection=function(e,t){if(this.collections.contains(e)){return this.collections.get(e).c}if(!t){t={secret:"dummy"}}var i=Scule.db.functions.parseCollectionURL(e);if(!(i.plugin in Scule.db.plugins)){throw i.plugin+" is not a registered Scule plugin"}if(!(i.engine in Scule.db.engines)){throw i.engine+" is nto a registered Scule storage engine"}var s=new Scule.db.engines[i.engine](t);var r=new Scule.db.plugins[i.plugin](i.name);r.setStorageEngine(s);r.open();this.collections.put(e,{c:r,t:(new Date).getTime()});return this.collections.get(e).c}};Scule.db.functions.debug=function(e){if(Scule.db.variables.debug===true){console.log(e)}};Scule.db.functions.unflattenObject=function(e){var t=function(e){if(Scule.global.functions.isScalar(e)){return}for(var i in e){if(e.hasOwnProperty(i)){var s=e[i];if(!Scule.global.functions.isScalar(s)&&"$type"in e[i]){switch(s.$type){case"date":e[i]=new Scule.db.classes.ObjectDate(s.sec,s.usec);e[i].ts=s.ts;break;case"id":e[i]=new Scule.db.classes.ObjectId(s.id);break;case"dbref":e[i]=new Scule.db.classes.DBRef(s.ref,s.id);break}}else{t(s)}}}};t(e);if(!(Scule.global.constants.ID_FIELD in e)){e[Scule.global.constants.ID_FIELD]=new Scule.db.classes.ObjectId}};Scule.db.functions.parseCollectionURL=function(e){var t=e.match(/^([^\+]*)\+([^\/]*)\:\/\/(.*)/);if(!t||t.length!=4){throw e+" is an invalid collection url"}return{plugin:t[1],engine:t[2],name:t[3]}};Scule.db.objects.core.collections.factory=new Scule.db.classes.CollectionFactory;Scule.debug=function(e){Scule.db.variables.debug=e};Scule.registerStorageEngine=function(e,t){if(e in Scule.db.engines){throw e+" storage engine is already registered"}Scule.db.engines[e]=t};Scule.registerCollectionPlugin=function(e,t){if(e in Scule.db.plugins){throw e+" collection plugin is already registered"}Scule.db.plugins[e]=t};(function(){Scule.registerStorageEngine("memory",Scule.db.classes.MemoryStorageEngine);Scule.registerStorageEngine("dummy",Scule.db.classes.DummyStorageEngine);Scule.registerStorageEngine("local",Scule.db.classes.LocalStorageStorageEngine);Scule.registerCollectionPlugin("scule",Scule.db.classes.Collection)})();Scule.factoryCollection=function(e){return Scule.db.objects.core.collections.factory.getCollection(e)};Scule.dropAll=function(){Scule.db.objects.core.collections.factory.collections.clear()};Scule.getIndex=function(){return new Scule.db.classes.Index};Scule.getHashTableIndex=function(e){return new Scule.db.classes.HashTableIndex(e)
};Scule.getBPlusTreeIndex=function(e){return new Scule.db.classes.BPlusTreeIndex(e)};Scule.getObjectId=function(e){return new Scule.db.classes.ObjectId(e)};Scule.getObjectDate=function(e,t){return new Scule.db.classes.ObjectDate(e,t)};Scule.getDBRef=function(e,t){return new Scule.db.classes.DBRef(e,t)};Scule.getMemoryStorageEngine=function(e){return new Scule.db.classes.MemoryStorageEngine(e)};Scule.getLocalStorageDiskStorageEngine=function(e){return new Scule.db.classes.LocalStorageDiskStorageEngine(e)};Scule.getSimpleCryptographyProvider=function(){return new Scule.db.classes.SimpleCryptographyProvider};Scule.getBPlusHashingTree=function(e,t){return new Scule.db.classes.BPlusHashingTree(e,t)};Scule.getHashBucketTable=function(){return new Scule.db.classes.HashBucketTable}})();